<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Conte√∫do - Portal PSR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #003366; --accent: #DAA520; --bg: #f4f7f9; --success: #28a745; --danger: #dc3545;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06); --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            padding: 20px; color: #333; margin: 0; padding-bottom: 100px;
        }

        .header { text-align: center; margin-bottom: 40px; }
        
        .header h1 { 
            color: var(--primary); margin: 0 0 20px 0; font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary) 0%, #004d99 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* MENU DE NAVEGA√á√ÉO */
        .view-switcher { 
            display: flex; justify-content: center; gap: 12px; margin-bottom: 35px;
            background: white; padding: 10px; border-radius: 50px;
            box-shadow: var(--shadow-md); width: fit-content; margin-left: auto; margin-right: auto;
            flex-wrap: wrap;
        }
        .view-btn { 
            text-decoration: none; border: none; background: transparent; 
            padding: 12px 24px; border-radius: 25px; cursor: pointer; 
            font-weight: 600; color: #777; transition: var(--transition); 
            display: flex; align-items: center; gap: 8px; font-size: 0.9em;
        }
        .view-btn.active { 
            background: var(--primary); color: white; 
            box-shadow: 0 6px 16px rgba(0,51,102,0.25); transform: translateY(-2px);
        }
        .view-btn:hover:not(.active) { background: rgba(0,51,102,0.05); }

        /* GRID E CARDS */
        .dashboard-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; max-width: 1400px; margin: 0 auto; 
        }
        .card { 
            background: white; padding: 28px; border-radius: 16px; 
            box-shadow: var(--shadow-sm); display: flex; flex-direction: column; 
            position: relative; border-top: 4px solid var(--primary);
            transition: var(--transition);
        }
        .card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        
        .card-header { 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 22px; 
        }
        .card h2 { 
            margin: 0; color: var(--primary); font-size: 1.2em; 
            display: flex; align-items: center; gap: 10px; 
        }
        
        /* FORMUL√ÅRIOS */
        .form-group { margin-bottom: 18px; width: 100%; }
        .form-group label { 
            display: block; font-weight: 600; margin-bottom: 7px; 
            font-size: 0.85em; color: #555; text-transform: uppercase; 
        }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 12px 14px; border: 2px solid #e0e0e0; 
            border-radius: 8px; font-family: inherit; font-size: 0.9em; 
            background: #fafafa; transition: 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus { 
            border-color: var(--primary); outline: none; background: white; 
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }
        
        /* BOT√ÉO SALVAR FLUTUANTE */
        .btn-save { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: linear-gradient(135deg, var(--primary) 0%, #004d99 100%); 
            color: white; border: none; padding: 16px 60px; border-radius: 50px; 
            font-size: 1.15em; font-weight: bold; cursor: pointer; 
            box-shadow: 0 10px 25px rgba(0, 51, 102, 0.3); z-index: 100; 
            transition: transform 0.3s; display: flex; align-items: center; gap: 10px;
        }
        .btn-save:hover { transform: translateX(-50%) translateY(-5px); }
        
        /* UTILIT√ÅRIOS */
        .cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .client-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; align-items: center; }
        
        .client-remove { 
            background: #ffe5e5; border: 1px solid #ffcccc; color: #dc3545; 
            width: 34px; height: 34px; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            transition: 0.2s;
        }
        .client-remove:hover { background: #dc3545; color: white; }

        .btn-add-client { 
            width: 100%; padding: 12px; background: #f0f4f8; 
            border: 2px dashed #cedae6; color: var(--primary); 
            cursor: pointer; border-radius: 8px; font-weight: 600; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-add-client:hover { background: #e1e8ef; border-color: var(--primary); }
        
        /* Loading Overlay */
        #loading { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(255,255,255,0.95); z-index:9999; 
            display:flex; justify-content:center; align-items:center; flex-direction:column;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Painel PSR</h1>
    <div class="view-switcher">
        <a href="editor.html" class="view-btn active"><i class="fas fa-edit"></i> Editor</a>
        <a href="interacoes.html" class="view-btn"><i class="fas fa-chart-line"></i> Intera√ß√µes</a>
        <a href="trafego_interno.html" class="view-btn"><i class="fas fa-network-wired"></i> Tr√°fego Interno</a>
        <a href="trafego_portal.html" class="view-btn"><i class="fas fa-globe"></i> Tr√°fego Portal</a>
    </div>
</div>

<form id="dashboardForm" onsubmit="event.preventDefault(); confirmSave();">
    <div class="dashboard-grid">
        <!-- TEMA DO M√äS -->
        <div class="card">
            <div class="card-header"><h2><i class="fas fa-calendar-alt"></i> Tema do M√™s</h2></div>
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="tema-titulo" placeholder="Ex: Janeiro Branco"></div>
            <div class="form-group"><label>Subt√≠tulo:</label><input type="text" id="tema-subtitulo" placeholder="Ex: Quem cuida da mente, cuida da vida!"></div>
            <div class="form-group"><label>CAPA URL (Fundo):</label><input type="text" id="tema-capa" placeholder="Link da imagem de fundo"></div>
            <div class="form-group"><label>Resumo (Capa):</label><textarea id="tema-resumo" rows="3" placeholder="Texto curto que aparece no topo..."></textarea></div>
            <div class="form-group"><label>Conte√∫do HTML:</label><textarea id="tema-conteudo" rows="6" placeholder="<p>Texto completo...</p>"></textarea></div>
            <div class="cols-2">
                <div class="form-group"><label>Fonte Nome:</label><input type="text" id="tema-fonte-nome"></div>
                <div class="form-group"><label>Fonte Link:</label><input type="text" id="tema-fonte-link"></div>
            </div>
        </div>

        <!-- PARTIU PENSAR (SUBSTITUIU RECEITA) -->
        <div class="card">
            <div class="card-header"><h2><i class="fas fa-lightbulb"></i> Partiu Pensar</h2></div>
            <div class="form-group"><label>T√≠tulo:</label><input type="text" id="pp-titulo" placeholder="Ex: Partiu Pensar"></div>
            <div class="form-group"><label>Subt√≠tulo (Categoria):</label><input type="text" id="pp-subtitulo" placeholder="Ex: Filosofia"></div>
            <div class="form-group"><label>Imagem de Fundo URL:</label><input type="text" id="pp-bg" placeholder="Link da imagem (opcional)"></div>
            <div class="form-group"><label>Resumo (Chamada):</label><textarea id="pp-resumo" rows="2" placeholder="Frase curta de impacto..."></textarea></div>
            <div class="form-group"><label>Conte√∫do Completo (HTML):</label><textarea id="pp-conteudo" rows="5" placeholder="<p>Texto da reflex√£o...</p>"></textarea></div>
            <div class="form-group"><label>Fonte / Autor:</label><input type="text" id="pp-fonte" placeholder="Ex: Mario Sergio Cortella"></div>
        </div>

        <!-- SAUDE E BEM ESTAR -->
        <div class="card">
            <div class="card-header"><h2><i class="fas fa-heartbeat"></i> Bem-Estar</h2></div>
            <div class="form-group"><label>Subt√≠tulo:</label><input type="text" id="saude-subtitulo" placeholder="Ex: Dicas de Ergonomia"></div>
            <div class="form-group"><label>Resumo:</label><textarea id="saude-resumo" rows="3"></textarea></div>
            <div class="form-group"><label>Conte√∫do HTML:</label><textarea id="saude-conteudo" rows="6"></textarea></div>
            <div class="form-group"><label>Link Fonte:</label><input type="text" id="saude-link"></div>
        </div>

        <!-- INDICA A√ç (Livros e Filmes) -->
        <div class="card">
            <div class="card-header"><h2><i class="fas fa-film"></i> Indica A√≠ (Cultura)</h2></div>
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #eee;">
                <strong style="color:var(--primary); display:block; margin-bottom:10px;">üé• V√≠deo/Filme (Posi√ß√£o 0)</strong>
                <div class="form-group"><label>T√≠tulo:</label><input type="text" id="cultura-0-titulo"></div>
                <div class="form-group"><label>Link:</label><input type="text" id="cultura-0-link"></div>
                <div class="form-group"><label>Capa URL:</label><input type="text" id="cultura-0-img"></div>
                <div class="form-group"><label>Indicado Por:</label><input type="text" id="cultura-0-indicado"></div>
                <div class="form-group"><label>Sinopse:</label><textarea id="cultura-0-sinopse"></textarea></div>
            </div>
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; border:1px solid #eee;">
                <strong style="color:var(--primary); display:block; margin-bottom:10px;">üìö Livro (Posi√ß√£o 1)</strong>
                <div class="form-group"><label>T√≠tulo:</label><input type="text" id="cultura-1-titulo"></div>
                <div class="form-group"><label>Link:</label><input type="text" id="cultura-1-link"></div>
                <div class="form-group"><label>Capa URL:</label><input type="text" id="cultura-1-img"></div>
                <div class="form-group"><label>Indicado Por:</label><input type="text" id="cultura-1-indicado"></div>
                <div class="form-group"><label>Sinopse:</label><textarea id="cultura-1-sinopse"></textarea></div>
            </div>
        </div>

        <!-- HOBBY -->
        <div class="card">
            <div class="card-header"><h2><i class="fas fa-user-circle"></i> Al√©m do Crach√°</h2></div>
            <div class="form-group"><label>Nome:</label><input type="text" id="hobby-nome"></div>
            <div class="form-group"><label>Setor/Cargo:</label><input type="text" id="hobby-cargo"></div>
            <div class="form-group"><label>Foto URL:</label><input type="text" id="hobby-foto"></div>
            <div class="form-group"><label>Texto:</label><textarea id="hobby-texto" rows="4"></textarea></div>
            <div class="form-group"><label>Tags (Separe por v√≠rgula):</label><input type="text" id="hobby-tags" placeholder="Ex: ‚òï Caf√©, üê∂ Animais"></div>
        </div>

        <!-- NOVOS CLIENTES -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-briefcase"></i> Novos Clientes</h2>
                <button type="button" class="client-remove" onclick="document.getElementById('clientes-list').innerHTML=''; addNewClientRow();" title="Limpar Lista"><i class="fas fa-trash"></i></button>
            </div>
            <div class="cols-2">
                <div class="form-group"><label>Qtd Resumo:</label><input type="text" id="clientes-qtd"></div>
                <div class="form-group"><label>Per√≠odo:</label><input type="text" id="clientes-periodo"></div>
            </div>
            <label style="font-size:0.8em; color:#666; margin-top:10px; display:block;">LISTA (Copie e cole do Excel na caixa de texto):</label>
            <div id="clientes-list" style="margin-top:10px;"></div>
            <button type="button" class="btn-add-client" onclick="addNewClientRow()">+ Adicionar Linha</button>
        </div>
    </div>
</form>

<button class="btn-save" onclick="confirmSave()"><i class="fas fa-save"></i> PUBLICAR NO SITE</button>

<div id="loading"><div><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i></div><h3 style="color:var(--primary); margin-top:15px;">Carregando dados...</h3></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyBzMvAw9ahEyd-tSYY08HxcMzo9RKf3IFY", authDomain: "jornalpsr-1b8c6.firebaseapp.com", databaseURL: "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com", projectId: "jornalpsr-1b8c6" };
    firebase.initializeApp(firebaseConfig);
    
    let AUTH_TOKEN = null;
    const CONTENT_URL = "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com/content.json";
    const CATEGORIES_MAP = { "A√ßougues": "ü•©", "Restaurantes": "üçΩÔ∏è", "Ind√∫stria": "üè≠", "Transporte": "üöö", "Com√©rcio": "üè™", "Servi√ßos": "üíº", "Outros": "üè¢", "Farm√°cias": "üíä", "E-commerce": "üì¶", "Automotivo": "üöó", "T√™xtil": "üëï" };

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            user.getIdToken().then(token => { AUTH_TOKEN = token; loadContent(); });
        } else {
            firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
        }
    });

    async function loadContent() {
        try {
            const resp = await fetch(CONTENT_URL + "?auth=" + AUTH_TOKEN);
            const data = await resp.json();
            document.getElementById('loading').style.display = 'none';
            if(!data) return;

            // Tema do M√™s (Agora com Capa URL)
            setVal('tema-titulo', data.temaMes?.titulo);
            setVal('tema-subtitulo', data.temaMes?.subtitulo);
            setVal('tema-resumo', data.temaMes?.resumo);
            setVal('tema-conteudo', data.temaMes?.conteudoCompleto);
            setVal('tema-fonte-nome', data.temaMes?.fonte?.texto);
            setVal('tema-fonte-link', data.temaMes?.fonte?.link);
            // Campo Novo: CAPA URL. Se n√£o existir no JSON antigo, vem vazio.
            // Nota: No JSON antigo, a capa era fixa no CSS ou n√£o existia campo. Vamos assumir que criaremos esse campo agora.
            // Para n√£o quebrar se n√£o existir, usamos ?. ou fallback.
            // O jornal espera que essa info esteja em algum lugar. Vamos salvar em temaMes.capaUrl
            setVal('tema-capa', data.temaMes?.capaUrl);

            // Partiu Pensar (Substitui Receita)
            setVal('pp-titulo', data.partiuPensar?.titulo);
            setVal('pp-subtitulo', data.partiuPensar?.subtitulo);
            setVal('pp-bg', data.partiuPensar?.imagemFundo);
            setVal('pp-resumo', data.partiuPensar?.resumo);
            setVal('pp-conteudo', data.partiuPensar?.conteudoCompleto);
            setVal('pp-fonte', data.partiuPensar?.fonte);

            // Bem Estar
            setVal('saude-subtitulo', data.saudeFisica?.subtitulo);
            setVal('saude-resumo', data.saudeFisica?.resumo);
            setVal('saude-conteudo', data.saudeFisica?.conteudoCompleto);
            setVal('saude-link', data.saudeFisica?.fonte?.link);

            // Cultura
            if(data.cultura) {
                data.cultura.forEach((item, i) => {
                    if(i>1) return;
                    setVal(`cultura-${i}-titulo`, item.titulo);
                    setVal(`cultura-${i}-link`, item.link);
                    setVal(`cultura-${i}-img`, item.img);
                    setVal(`cultura-${i}-indicado`, item.indicadoPor);
                    setVal(`cultura-${i}-sinopse`, item.sinopse);
                });
            }

            // Hobby
            if(data.hobby) {
                setVal('hobby-nome', data.hobby.nome);
                setVal('hobby-cargo', data.hobby.cargo);
                setVal('hobby-foto', data.hobby.foto);
                setVal('hobby-texto', data.hobby.texto);
                setVal('hobby-tags', data.hobby.tags ? data.hobby.tags.join(', ') : '');
            }

            // Novos Clientes
            if(data.novos_clientes) {
                setVal('clientes-qtd', data.novos_clientes.resumo?.quantidade);
                setVal('clientes-periodo', data.novos_clientes.resumo?.periodo);
                const list = document.getElementById('clientes-list');
                list.innerHTML = '';
                if(data.novos_clientes.lista) {
                    data.novos_clientes.lista.forEach(c => {
                        let catKey = Object.keys(CATEGORIES_MAP).find(k => CATEGORIES_MAP[k] === c.icone) || "Outros";
                        addNewClientRow(catKey, c.nome);
                    });
                } else {
                    addNewClientRow();
                }
            }

        } catch(e) { console.error(e); alert("Erro ao carregar dados."); }
    }

    async function confirmSave() {
        if(!confirm("Tem certeza que deseja publicar as altera√ß√µes?")) return;
        
        // Mant√©m a estrutura existente para n√£o perder Desafios e Sustentabilidade
        let currentData = {};
        try {
            const resp = await fetch(CONTENT_URL + "?auth=" + AUTH_TOKEN);
            currentData = await resp.json() || {};
        } catch(e) {}

        const data = {
            temaMes: {
                titulo: getVal('tema-titulo'),
                subtitulo: getVal('tema-subtitulo'),
                resumo: getVal('tema-resumo'),
                conteudoCompleto: getVal('tema-conteudo'),
                capaUrl: getVal('tema-capa'), // CAMPO NOVO
                fonte: { texto: getVal('tema-fonte-nome'), link: getVal('tema-fonte-link') }
            },
            // CAMPO NOVO: PARTIU PENSAR
            partiuPensar: {
                titulo: getVal('pp-titulo'),
                subtitulo: getVal('pp-subtitulo'),
                imagemFundo: getVal('pp-bg'),
                resumo: getVal('pp-resumo'),
                conteudoCompleto: getVal('pp-conteudo'),
                fonte: getVal('pp-fonte')
            },
            saudeFisica: {
                subtitulo: getVal('saude-subtitulo'),
                resumo: getVal('saude-resumo'),
                conteudoCompleto: getVal('saude-conteudo'),
                fonte: { link: getVal('saude-link'), texto: "Fonte" }
            },
            cultura: [
                { id: "filme_mes", tipo: "video", titulo: getVal('cultura-0-titulo'), link: getVal('cultura-0-link'), img: getVal('cultura-0-img'), indicadoPor: getVal('cultura-0-indicado'), sinopse: getVal('cultura-0-sinopse'), tag: "Indica√ß√£o" },
                { id: "livro_mes", tipo: "livro", titulo: getVal('cultura-1-titulo'), link: getVal('cultura-1-link'), img: getVal('cultura-1-img'), indicadoPor: getVal('cultura-1-indicado'), sinopse: getVal('cultura-1-sinopse'), tag: "Leitura" }
            ],
            hobby: {
                nome: getVal('hobby-nome'),
                cargo: getVal('hobby-cargo'),
                foto: getVal('hobby-foto'),
                texto: getVal('hobby-texto'),
                tags: getVal('hobby-tags').split(',').map(t=>t.trim()).filter(t=>t)
            },
            // Receitas foi removido do formul√°rio, mas mantemos o objeto vazio ou antigo para n√£o dar erro se o app tentar ler
            receitas: currentData.receitas || [], 
            
            novos_clientes: {
                resumo: { quantidade: getVal('clientes-qtd'), periodo: getVal('clientes-periodo') },
                lista: Array.from(document.querySelectorAll('.client-row')).map(row => ({
                    icone: CATEGORIES_MAP[row.querySelector('select').value] || "üè¢",
                    nome: row.querySelector('input').value,
                    destaque: false, data: ""
                })).filter(c => c.nome)
            },
            // Preserva Desafios e Sustentabilidade que n√£o s√£o editados aqui
            desafios: currentData.desafios || [ 
                {id: "hidratacao", emoji: "üíß", titulo: "Hidrata√ß√£o", desc: "Beba 2L de √°gua"},
                {id: "passos", emoji: "üö∂", titulo: "10k Passos", desc: "Caminhe todo dia"},
                {id: "sono", emoji: "üò¥", titulo: "Sono", desc: "Durma 8h"}
            ],
            sustentabilidade: currentData.sustentabilidade || {}
        };

        try {
            await fetch(CONTENT_URL + "?auth=" + AUTH_TOKEN, { method: 'PUT', body: JSON.stringify(data) });
            alert("Conte√∫do publicado com sucesso!");
        } catch(e) { alert("Erro ao salvar: " + e.message); }
    }

    function addNewClientRow(cat="", name="") {
        const div = document.createElement('div'); div.className = 'client-row';
        let options = ''; 
        for(let k in CATEGORIES_MAP) options += `<option value="${k}" ${k===cat?'selected':''}>${k}</option>`;
        div.innerHTML = `<select class="client-select" style="padding:10px; border-radius:8px; border:2px solid #ddd;">${options}</select><div style="display:flex;gap:5px;width:100%"><input type="text" value="${name}" class="client-input"><button type="button" class="client-remove" onclick="this.closest('.client-row').remove()"><i class="fas fa-trash"></i></button></div>`;
        document.getElementById('clientes-list').appendChild(div);
    }

    document.getElementById('clientes-list').addEventListener('paste', e => {
        if(!e.target.classList.contains('client-input')) return;
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if(!text.includes('\n')) return;
        e.preventDefault();
        const lines = text.split(/\r?\n/).filter(l=>l.trim());
        const cat = e.target.closest('.client-row').querySelector('select').value;
        e.target.value = lines[0];
        for(let i=1; i<lines.length; i++) addNewClientRow(cat, lines[i]);
    });

    function getVal(id) { return document.getElementById(id)?.value || ""; }
    function setVal(id, v) { if(document.getElementById(id)) document.getElementById(id).value = v || ""; }
</script>
</body>
</html>
