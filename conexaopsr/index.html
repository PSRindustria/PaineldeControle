<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Portal PSR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #003366; 
            --accent: #DAA520; 
            --bg: #f4f7f9; 
            --success: #28a745; 
            --danger: #dc3545;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            padding: 20px; 
            color: #333; 
            margin: 0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(0, 51, 102, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(218, 165, 32, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: floatBg 20s ease-in-out infinite;
        }

        @keyframes floatBg {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, 20px); }
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 40px; 
            position: relative;
            z-index: 1;
            animation: slideDown 0.6s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header h1 { 
            color: var(--primary); 
            margin: 0 0 10px 0; 
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
            background: linear-gradient(135deg, var(--primary) 0%, #004d99 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .view-switcher {
            display: flex; 
            justify-content: center; 
            gap: 12px; 
            margin-bottom: 35px;
            background: white; 
            padding: 8px; 
            border-radius: 50px;
            box-shadow: var(--shadow-md);
            width: fit-content; 
            margin-left: auto; 
            margin-right: auto;
            position: relative;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.6s ease 0.3s forwards;
        }

        .view-switcher::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            to { transform: translateX(100%); }
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .view-btn {
            border: none; 
            background: transparent; 
            padding: 12px 28px; 
            border-radius: 25px;
            cursor: pointer; 
            font-weight: 600; 
            color: #777; 
            transition: var(--transition);
            display: flex; 
            align-items: center; 
            gap: 8px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .view-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: var(--primary);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            z-index: -1;
        }

        .view-btn.active::before {
            width: 100%;
            height: 100%;
            border-radius: 25px;
        }

        .view-btn.active { 
            color: white; 
            box-shadow: 0 6px 16px rgba(0,51,102,0.25);
            transform: translateY(-2px);
        }

        .view-btn:hover:not(.active) { 
            background: rgba(0,51,102,0.05);
            transform: translateY(-1px);
        }

        .view-btn i {
            transition: transform 0.3s ease;
        }

        .view-btn:hover i {
            transform: scale(1.1);
        }

        #view-content, #view-interactions, #view-traffic { 
            display: none;
        }
        
        .view-active { 
            display: block !important; 
            animation: fadeInScale 0.5s ease;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; 
            max-width: 1400px; 
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .card { 
            background: white; 
            padding: 28px; 
            border-radius: 16px; 
            box-shadow: var(--shadow-sm);
            display: flex; 
            flex-direction: column;
            overflow: hidden; 
            position: relative; 
            border: 1px solid rgba(0,0,0,0.04);
            transition: var(--transition);
            animation: cardSlideIn 0.5s ease backwards;
        }

        @keyframes cardSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.15s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.25s; }
        .card:nth-child(5) { animation-delay: 0.3s; }
        .card:nth-child(6) { animation-delay: 0.35s; }
        .card:nth-child(7) { animation-delay: 0.4s; }

        .card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 4px; 
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: height 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: rgba(0,51,102,0.1);
        }

        .card:hover::before {
            height: 6px;
        }
        
        .card-interaction { 
            border-top: 4px solid var(--accent) !important; 
        }
        
        .card-interaction::before { 
            background: linear-gradient(90deg, var(--accent), #f4d03f);
        }
        
        .card-interaction .card-header h2 { 
            font-size: 1.1em; 
            color: #444; 
        }

        .card-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom: 2px solid #f0f0f0; 
            padding-bottom: 12px; 
            margin-bottom: 22px;
            position: relative;
        }

        .card-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .card:hover .card-header::after {
            width: 120px;
        }
        
        .card h2 { 
            margin: 0; 
            color: var(--primary); 
            font-size: 1.2em; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }

        .card h2 i {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .monitor-list { 
            max-height: 300px; 
            overflow-y: auto; 
            padding-right: 5px;
        }

        .monitor-list::-webkit-scrollbar {
            width: 6px;
        }

        .monitor-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .monitor-list::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .monitor-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .monitor-item {
            background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
            border-left: 3px solid var(--accent);
            border-bottom: 1px solid #eee; 
            padding: 12px;
            margin-bottom: 8px; 
            border-radius: 8px; 
            font-size: 0.85em; 
            position: relative;
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            gap: 10px;
            transition: var(--transition);
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .monitor-item:hover {
            background: linear-gradient(135deg, #fff 0%, #f0f4f8 100%);
            box-shadow: var(--shadow-sm);
            border-left-width: 4px;
            transform: translateX(4px);
        }

        .monitor-content { 
            flex: 1; 
            word-break: break-word; 
        }
        
        .monitor-item strong { 
            color: var(--primary); 
            display: block; 
            margin-bottom: 3px;
        }
        
        .monitor-item small { 
            color: #888; 
            display: block; 
            margin-top: 4px; 
            font-size: 0.75em; 
        }
        
        .id-badge {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #495057; 
            padding: 3px 8px; 
            border-radius: 6px;
            font-family: monospace; 
            font-size: 0.8em; 
            border: 1px solid #ced4da;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .id-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn-trash {
            background: linear-gradient(135deg, #fff0f0 0%, #ffe5e5 100%);
            border: 1px solid #ffcccc; 
            color: var(--danger);
            width: 28px; 
            height: 28px; 
            border-radius: 6px; 
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-shrink: 0;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-trash::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--danger);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .btn-trash:hover::before {
            width: 100%;
            height: 100%;
        }

        .btn-trash:hover { 
            color: white; 
            border-color: var(--danger);
            transform: rotate(10deg) scale(1.1);
        }

        .btn-trash i {
            position: relative;
            z-index: 1;
        }

        .filter-bar {
            display: flex; 
            justify-content: flex-end; 
            align-items: center; 
            gap: 12px;
            max-width: 1400px; 
            margin: 0 auto 25px; 
            background: white; 
            padding: 14px 24px;
            border-radius: 12px; 
            box-shadow: var(--shadow-sm);
            animation: slideDown 0.5s ease;
        }

        .date-input {
            padding: 10px 14px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-family: inherit; 
            color: #555;
            transition: var(--transition);
            background: #fafafa;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        .date-input:hover {
            border-color: var(--accent);
        }

        .btn-global-clear { 
            margin-top: 15px; 
            background: linear-gradient(135deg, #ffebeb 0%, #ffe0e0 100%);
            color: #dc3545; 
            border: 2px solid #dc3545; 
            padding: 10px 24px; 
            border-radius: 25px; 
            font-size: 0.85em; 
            cursor: pointer; 
            font-weight: 600; 
            text-transform: uppercase; 
            transition: var(--transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-global-clear::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--danger);
            transition: left 0.3s ease;
            z-index: 0;
        }

        .btn-global-clear:hover::before {
            left: 0;
        }

        .btn-global-clear:hover { 
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220,53,69,0.3);
        }

        .btn-global-clear i, .btn-global-clear span {
            position: relative;
            z-index: 1;
        }

        .btn-clear-header { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #666; 
            border: 1px solid #ddd; 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-size: 0.75em; 
            cursor: pointer; 
            font-weight: 600; 
            text-transform: uppercase; 
            transition: var(--transition);
            display: flex; 
            align-items: center; 
            gap: 5px;
        }

        .btn-clear-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-save { 
            background: linear-gradient(135deg, var(--primary) 0%, #004d99 100%);
            color: white; 
            border: none; 
            padding: 16px 60px; 
            border-radius: 50px; 
            font-size: 1.15em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: var(--transition);
            box-shadow: 0 6px 20px rgba(0, 51, 102, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-save::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn-save:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 51, 102, 0.4);
        }

        .btn-save:active {
            transform: translateY(-1px);
        }

        .btn-save i {
            position: relative;
            z-index: 1;
            margin-right: 8px;
            animation: saveIcon 1s ease-in-out infinite;
        }

        @keyframes saveIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .save-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(255,255,255,0.95);
            padding: 18px; 
            box-shadow: 0 -8px 24px rgba(0,0,0,0.12);
            text-align: center; 
            z-index: 100;
            backdrop-filter: blur(10px);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .btn-refresh { 
            background: linear-gradient(135deg, var(--success) 0%, #239f3d 100%);
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.9em; 
            display: inline-flex; 
            align-items: center; 
            gap: 6px;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(40,167,69,0.2);
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40,167,69,0.3);
        }

        .btn-refresh i {
            transition: transform 0.3s ease;
        }

        .btn-refresh:hover i {
            transform: rotate(180deg);
        }

        .form-group { 
            margin-bottom: 18px; 
            width: 100%;
        }
        
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 7px; 
            font-size: 0.85em; 
            color: #555; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 12px 14px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 0.9em; 
            transition: var(--transition);
            background: #fafafa;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            border-color: var(--primary); 
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
            transform: translateY(-1px);
        }

        .form-group input:hover, .form-group textarea:hover, .form-group select:hover {
            border-color: var(--accent);
        }

        .cols-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        
        .cols-3 { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 12px; 
        }
        
        .client-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-bottom: 12px; 
            align-items: center;
            animation: slideInLeft 0.3s ease;
        }
        
        .client-select { 
            width: 100%; 
            padding: 12px 16px; 
            border: 2px solid #e1e4e8; 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 0.9em; 
            background: #fafafa;
            cursor: pointer;
            transition: var(--transition);
        }

        .client-select:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        .client-select:hover {
            border-color: var(--accent);
        }
        
        .client-input-wrapper { 
            display: flex; 
            align-items: center; 
            width: 100%; 
            gap: 8px; 
        }
        
        .client-input { 
            flex: 1; 
            height: 46px; 
            padding: 0 12px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 0.9em;
            transition: var(--transition);
            background: #fafafa;
        }

        .client-input:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(0,51,102,0.1);
        }

        .client-input:hover {
            border-color: var(--accent);
        }
        
        .client-remove { 
            background: transparent; 
            border: none; 
            color: #bbb; 
            width: 34px; 
            height: 34px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: var(--transition);
        }
        
        .client-remove:hover { 
            color: #dc3545; 
            background-color: rgba(220, 53, 69, 0.1);
            transform: rotate(90deg) scale(1.1);
        }
        
        .btn-add-client { 
            background: linear-gradient(135deg, #f0f4f8 0%, #e3e9ef 100%);
            color: var(--primary); 
            border: 2px dashed #cedae6; 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-top: 12px; 
            font-size: 0.9em;
            font-weight: 600;
            transition: var(--transition);
        }

        .btn-add-client:hover {
            background: linear-gradient(135deg, #e3e9ef 0%, #d5dde5 100%);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .tabs-header { 
            display: flex; 
            border-bottom: 2px solid #eee; 
            margin-bottom: 18px;
            gap: 4px;
        }
        
        .tab-btn { 
            flex: 1; 
            padding: 12px; 
            text-align: center; 
            cursor: pointer; 
            background: #f8f9fa; 
            border: none; 
            border-bottom: 3px solid transparent; 
            font-weight: 600; 
            color: #777; 
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--accent);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }
        
        .tab-btn.active { 
            background: white; 
            color: var(--primary);
        }

        .tab-btn.active::before {
            width: 100%;
        }

        .tab-btn:hover:not(.active) {
            background: #f0f2f5;
            color: var(--primary);
        }
        
        .tab-content { 
            display: none;
        }
        
        .tab-content.active { 
            display: block;
            animation: fadeIn 0.4s ease;
        }
        
        .sub-card { 
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e8ecf0; 
            border-left: 4px solid var(--accent);
            padding: 18px; 
            border-radius: 10px; 
            margin-bottom: 18px;
            transition: var(--transition);
        }

        .sub-card:hover {
            box-shadow: var(--shadow-sm);
            transform: translateX(4px);
        }
        
        .sub-card-title { 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 12px; 
            font-size: 0.9em; 
            text-transform: uppercase; 
            border-bottom: 2px solid #e0e0e0; 
            padding-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .emoji-input { 
            font-size: 1.3em; 
            text-align: center; 
            width: 90px !important;
        }

        #toast { 
            position: fixed; 
            bottom: 110px; 
            right: 30px; 
            padding: 16px 28px; 
            border-radius: 12px; 
            color: white; 
            display: none; 
            z-index: 101; 
            font-weight: 600; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            animation: toastSlide 0.4s ease;
        }

        @keyframes toastSlide {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .success { 
            background: linear-gradient(135deg, #28a745 0%, #20893a 100%);
        }
        
        .error { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .kpi-row { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 25px; 
            flex-wrap: wrap;
        }
        
        .kpi-card { 
            flex: 1; 
            min-width: 200px; 
            background: white; 
            padding: 24px; 
            border-radius: 16px; 
            border-left: 5px solid var(--primary); 
            box-shadow: var(--shadow-sm);
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            animation: cardSlideIn 0.5s ease backwards;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transition: transform 0.6s ease;
        }

        .kpi-card:hover::before {
            transform: translate(-25%, -25%);
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
        }
        
        .kpi-card h3 { 
            color: #888; 
            font-size: 0.85em; 
            margin: 0 0 8px 0; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .kpi-card .value { 
            font-size: 2.5em; 
            font-weight: 700; 
            color: var(--primary);
            position: relative;
            z-index: 1;
            animation: countUp 1s ease;
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .kpi-card .icon { 
            float: right; 
            font-size: 2em; 
            opacity: 0.15;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            transition: var(--transition);
        }

        .kpi-card:hover .icon {
            opacity: 0.25;
            transform: translateY(-50%) scale(1.1);
        }
        
        .chart-container { 
            position: relative; 
            height: 300px; 
            width: 100%;
        }

        #login-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 51, 102, 0.95) 0%, rgba(0, 77, 153, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 99999;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            text-align: center;
            animation: overlayFade 0.5s ease;
        }

        @keyframes overlayFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #login-overlay::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
            opacity: 0.3;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            from { transform: translate(0, 0); }
            to { transform: translate(50px, 50px); }
        }

        .login-box {
            background: white; 
            padding: 50px 60px; 
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%; 
            width: 450px;
            position: relative;
            z-index: 1;
        }

        .login-title { 
            color: #003366; 
            font-size: 2em; 
            margin-bottom: 12px; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-box i.fa-lock {
            animation: lockShake 2s ease-in-out infinite;
        }

        @keyframes lockShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .btn-login-google {
            background: linear-gradient(135deg, #4285F4 0%, #3367D6 100%);
            color: white; 
            border: none; 
            padding: 18px 30px; 
            width: 100%;
            font-size: 1.2rem; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            transition: var(--transition);
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.35);
            font-family: 'Poppins', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .btn-login-google::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn-login-google:hover::before {
            width: 400px;
            height: 400px;
        }

        .btn-login-google:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 15px 35px rgba(66, 133, 244, 0.5); 
        }
        
        .btn-login-google:active { 
            transform: translateY(-1px); 
        }

        .btn-login-google i {
            position: relative;
            z-index: 1;
        }
        
        @keyframes popIn { 
            from { opacity: 0; transform: scale(0.9) translateY(-30px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .view-switcher { flex-direction: column; width: 90%; }
            .view-btn { justify-content: center; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .kpi-row { flex-direction: column; }
            .login-box { padding: 40px 30px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Painel PSR</h1>
    
    <div class="view-switcher">
        <button class="view-btn active" onclick="switchView('content')">
            <i class="fas fa-edit"></i> Editor de Conte√∫do
        </button>
        <button class="view-btn" onclick="switchView('interactions')">
            <i class="fas fa-chart-line"></i> Monitor de Intera√ß√µes
        </button>
        <button class="view-btn" onclick="switchView('traffic')">
            <i class="fas fa-chart-pie"></i> Monitor de Tr√°fego
        </button>
    </div>

    <div id="editor-controls">
        <button type="button" class="btn-global-clear" onclick="clearAllFields()">
            <i class="fas fa-trash"></i> <span>Limpar Todo o Painel</span>
        </button>
    </div>
</div>

<div id="view-content" class="view-active">
    <form id="dashboardForm" onsubmit="event.preventDefault(); confirmSave();">
        <div class="dashboard-grid">
            
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-calendar-alt"></i> Tema do M√™s</h2></div>
                <div class="form-group"><label>T√≠tulo:</label><input type="text" id="tema-titulo" placeholder="Ex: Janeiro Branco"></div>
                <div class="form-group"><label>Subt√≠tulo:</label><input type="text" id="tema-subtitulo" placeholder="Ex: Quem cuida da mente, cuida da vida!"></div>
                <div class="form-group"><label>Resumo (Capa):</label><textarea id="tema-resumo" placeholder="Ex: Neste m√™s, convidamos a todos para uma reflex√£o..."></textarea></div>
                <div class="form-group"><label>Conte√∫do Completo (HTML):</label><textarea id="tema-conteudo" style="height: 150px;" placeholder="Ex: <p>Texto detalhado sobre a campanha...</p>"></textarea></div>
                <div class="form-group"><label>Fonte (Nome / Link):</label>
                    <div class="cols-2">
                        <input type="text" id="tema-fonte-nome" placeholder="Ex: G1 - Sa√∫de">
                        <input type="text" id="tema-fonte-link" placeholder="Ex: https://g1.globo.com...">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-film"></i> Indica A√≠</h2></div>
                <div class="tabs-header">
                    <button type="button" class="tab-btn active" onclick="openTab('tab-filme', this)">üé• Filme</button>
                    <button type="button" class="tab-btn" onclick="openTab('tab-livro', this)">üìö Livro</button>
                </div>
                <div id="tab-filme" class="tab-content active">
                    <input type="hidden" id="cult-filme-id" value="filme_mes">
                    <input type="hidden" id="cult-filme-tipo" value="video">
                    <div class="form-group"><label>T√≠tulo do Filme:</label><input type="text" id="cult-filme-titulo" placeholder="Ex: O Dilema das Redes"></div>
                    <div class="form-group"><label>Link (YouTube):</label><input type="text" id="cult-filme-link" placeholder="Ex: https://youtube.com/watch?v=..."></div>
                    <div class="form-group"><label>Capa URL:</label><input type="text" id="cult-filme-img" placeholder="Ex: https://img.youtube.com/..."></div>
                    <div class="form-group"><label>Indicado por:</label><input type="text" id="cult-filme-indicado" placeholder="Ex: Jo√£o (TI)"></div>
                    <div class="form-group"><label>Sinopse:</label><textarea id="cult-filme-sinopse" placeholder="Ex: Especialistas do Vale do Sil√≠cio alertam..."></textarea></div>
                    <div class="form-group"><label>Categoria:</label><input type="text" id="cult-filme-tag" placeholder="Ex: Reflex√£o"></div>
                </div>
                <div id="tab-livro" class="tab-content">
                    <input type="hidden" id="cult-livro-id" value="livro_mes">
                    <input type="hidden" id="cult-livro-tipo" value="livro">
                    <div class="form-group"><label>T√≠tulo do Livro:</label><input type="text" id="cult-livro-titulo" placeholder="Ex: O Poder do H√°bito"></div>
                    <div class="form-group"><label>Link (Opcional):</label><input type="text" id="cult-livro-link" placeholder="Ex: https://amazon.com.br/..."></div>
                    <div class="form-group"><label>Capa URL:</label><input type="text" id="cult-livro-img" placeholder="Ex: https://imagens.com/livro.jpg"></div>
                    <div class="form-group"><label>Indicado por:</label><input type="text" id="cult-livro-indicado" placeholder="Ex: Maria (RH)"></div>
                    <div class="form-group"><label>Sinopse:</label><textarea id="cult-livro-sinopse" placeholder="Ex: O livro explora a ci√™ncia dos h√°bitos..."></textarea></div>
                    <div class="form-group"><label>Categoria:</label><input type="text" id="cult-livro-tag" placeholder="Ex: Autoajuda"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-user-circle"></i> Al√©m do Crach√°</h2></div>
                <div class="form-group"><label>Colaborador:</label><input type="text" id="hobby-nome" placeholder="Ex: Iasmim Ferreira"></div>
                <div class="form-group"><label>Setor:</label><input type="text" id="hobby-cargo" placeholder="Ex: Setor Financeiro"></div>
                <div class="form-group"><label>Foto URL:</label><input type="text" id="hobby-foto" placeholder="Ex: https://postimg.cc/..."></div>
                <div class="form-group"><label>Texto "Fora da PSR":</label><textarea id="hobby-texto" style="height: 120px;" placeholder="Ex: Gosto de passear com minha cachorrinha..."></textarea></div>
                <div class="form-group"><label>Tags (Skills/Hobbies - M√°x 3):</label>
                    <div class="cols-3">
                        <input type="text" id="hobby-tag-1" placeholder="Ex: ‚òï Caf√©">
                        <input type="text" id="hobby-tag-2" placeholder="Ex: üó∫Ô∏è Viajar">
                        <input type="text" id="hobby-tag-3" placeholder="Ex: üê∂ Animais">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-heartbeat"></i> Bem-Estar e Sa√∫de</h2></div>
                <div class="form-group"><label>Subt√≠tulo:</label><input type="text" id="bemestar-subtitulo" placeholder="Ex: A pausa necess√°ria"></div>
                <div class="form-group"><label>Resumo:</label><textarea id="bemestar-resumo" placeholder="Ex: Na correria do dia a dia..."></textarea></div>
                <div class="form-group"><label>Conte√∫do (HTML):</label><textarea id="bemestar-conteudo" style="height: 120px;" placeholder="Ex: <p>Dicas de ergonomia...</p>"></textarea></div>
                <div class="form-group"><label>Link da Fonte:</label><input type="text" id="bemestar-link" placeholder="Ex: https://blog.saude.com.br"></div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-utensils"></i> Receita do M√™s</h2></div>
                <div class="form-group"><label>Emoji:</label><input type="text" id="rec-emoji" class="emoji-input" placeholder="Ex: ü•ò"></div>
                <div class="form-group"><label>T√≠tulo:</label><input type="text" id="rec-titulo" placeholder="Ex: Salada de Quinoa"></div>
                <div class="form-group"><label>Tempo:</label><input type="text" id="rec-tempo" placeholder="Ex: 15 minutos"></div>
                <div class="form-group"><label>Indicado por:</label><input type="text" id="rec-indicado" placeholder="Ex: Nutricionista Ana"></div>
                <div class="form-group"><label>Descri√ß√£o:</label><textarea id="rec-desc" placeholder="Ex: Uma receita leve e nutritiva..."></textarea></div>
                <div class="form-group"><label>Ingredientes (separar por ;):</label><textarea id="rec-ing" placeholder="Ex: 1 tomate; Azeite; Sal a gosto"></textarea></div>
                <div class="form-group"><label>Preparo (separar por ;):</label><textarea id="rec-prep" placeholder="Ex: Corte os legumes; Misture tudo; Sirva gelado"></textarea></div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-dumbbell"></i> Desafios (3 Cards)</h2></div>
                <div class="sub-card">
                    <div class="sub-card-title">Desafio 1</div><input type="hidden" id="chal-1-id" value="hidratacao">
                    <div class="cols-2"><div class="form-group"><label>Emoji:</label><input type="text" id="chal-1-emoji" class="emoji-input" placeholder="Ex: üíß"></div><div class="form-group"><label>T√≠tulo:</label><input type="text" id="chal-1-titulo" placeholder="Ex: Hidrata√ß√£o"></div></div>
                    <div class="form-group"><label>Descri√ß√£o:</label><input type="text" id="chal-1-desc" placeholder="Ex: Beber 2L de √°gua"></div>
                </div>
                <div class="sub-card">
                    <div class="sub-card-title">Desafio 2</div><input type="hidden" id="chal-2-id" value="passos">
                    <div class="cols-2"><div class="form-group"><label>Emoji:</label><input type="text" id="chal-2-emoji" class="emoji-input" placeholder="Ex: üö∂"></div><div class="form-group"><label>T√≠tulo:</label><input type="text" id="chal-2-titulo" placeholder="Ex: 10 Mil Passos"></div></div>
                    <div class="form-group"><label>Descri√ß√£o:</label><input type="text" id="chal-2-desc" placeholder="Ex: Caminhada di√°ria"></div>
                </div>
                <div class="sub-card">
                    <div class="sub-card-title">Desafio 3</div><input type="hidden" id="chal-3-id" value="sono">
                    <div class="cols-2"><div class="form-group"><label>Emoji:</label><input type="text" id="chal-3-emoji" class="emoji-input" placeholder="Ex: üò¥"></div><div class="form-group"><label>T√≠tulo:</label><input type="text" id="chal-3-titulo" placeholder="Ex: Sono de Qualidade"></div></div>
                    <div class="form-group"><label>Descri√ß√£o:</label><input type="text" id="chal-3-desc" placeholder="Ex: Dormir 8h por noite"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h2><i class="fas fa-briefcase"></i> Novos Clientes</h2><button type="button" class="btn-clear-header" onclick="clearClientList()"><i class="fas fa-trash-alt"></i> Limpar Lista</button></div>
                <div class="cols-2">
                    <div class="form-group"><label>Qtd:</label><input type="text" id="clientes-qtd" placeholder="Ex: 6"></div>
                    <div class="form-group"><label>Per√≠odo:</label><input type="text" id="clientes-periodo" placeholder="Ex: Janeiro/2026"></div>
                </div>
                <label style="margin-top:10px; display:block; font-weight:600; font-size:0.85em; color:#555;">LISTA DE EMPRESAS (Selecione a categoria e cole a lista):</label>
                <div id="clientes-list"></div>
                <button type="button" class="btn-add-client" onclick="addNewClientRow()">+ Adicionar Cliente Manualmente</button>
            </div>

        </div>
        <div style="height: 80px;"></div>
    </form>
    <div class="save-bar"><button class="btn-save" onclick="confirmSave()"><i class="fas fa-save"></i> PUBLICAR NO SITE</button></div>
</div>

<div id="view-interactions">
    
    <div class="filter-bar">
        <div>
            <label style="font-size:0.85em; font-weight:600; color:#666; margin-right:5px;">Hist√≥rico:</label>
            <input type="month" id="monitor-filter-date" class="date-input" onchange="loadInteractions()">
        </div>
        <button class="btn-refresh" onclick="loadInteractions()"><i class="fas fa-sync-alt"></i></button>
    </div>

    <div class="dashboard-grid">
        
        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-shield-alt"></i> Quiz - Participantes</h2></div>
            <div class="monitor-list" id="monitor-quiz">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-user-circle"></i> Hobby - Curtidas (IDs)</h2></div>
            <div class="monitor-list" id="monitor-hobby-likes">Carregando...</div>
            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #eee;">
                <strong>Coment√°rios:</strong>
                <div class="monitor-list" id="monitor-hobby-comments" style="margin-top:5px;">Carregando...</div>
            </div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-dumbbell"></i> Desafios (IDs Detalhados)</h2></div>
            <div class="monitor-list" id="monitor-challenges">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-heart"></i> Elogios Enviados</h2></div>
            <div class="monitor-list" id="monitor-praise">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-gamepad"></i> Ranking Jogos</h2></div>
            <div class="monitor-list" id="monitor-games">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-lightbulb"></i> Sugest√µes Recebidas</h2></div>
            <div class="monitor-list" id="monitor-suggestions">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-bullhorn"></i> Comunicados</h2></div>
            <div class="monitor-list" id="monitor-comms">Carregando...</div>
        </div>

        <div class="card card-interaction">
            <div class="card-header"><h2><i class="fas fa-star"></i> Avalia√ß√µes (IDs)</h2></div>
            <div class="monitor-list" id="monitor-ratings">Carregando...</div>
        </div>

    </div>
</div>

<div id="view-traffic">
    <div style="max-width: 1400px; margin: 0 auto; padding-bottom: 50px;">
        
        <div class="filter-bar">
            <button class="btn-refresh" onclick="loadTrafficData()"><i class="fas fa-sync-alt"></i> Atualizar Dados</button>
        </div>

        <div class="kpi-row">
            <div class="kpi-card" style="border-color: #003366;">
                <h3>Visitantes √önicos (Hoje)</h3>
                <div class="value" id="kpi-visits">0</div>
                <i class="fas fa-user-friends icon"></i>
            </div>
            <div class="kpi-card" style="border-color: #DAA520;">
                <h3>A√ß√µes / Cliques (Hoje)</h3>
                <div class="value" id="kpi-events">0</div>
                <i class="fas fa-mouse-pointer icon"></i>
            </div>
            <div class="kpi-card" style="border-color: #28a745;">
                <h3>Novos Cadastros (Total)</h3>
                <div class="value" id="kpi-total-users">0</div>
                <i class="fas fa-id-card icon"></i>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-header"><h2><i class="fas fa-chart-line"></i> Fluxo de Visitas (M√™s Vigente)</h2></div>
                <div class="chart-container">
                    <canvas id="chartVisits"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h2><i class="fas fa-mobile-alt"></i> Dispositivos</h2></div>
                <div class="chart-container">
                    <canvas id="chartDevices"></canvas>
                </div>
            </div>
            <div class="card" style="grid-column: span 3;">
                <div class="card-header"><h2><i class="fas fa-hand-point-up"></i> Top Intera√ß√µes (Visitantes √önicos/Dia - M√™s Vigente)</h2></div>
                <div class="chart-container">
                    <canvas id="chartEvents"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBzMvAw9ahEyd-tSYY08HxcMzo9RKf3IFY",
        authDomain: "jornalpsr-1b8c6.firebaseapp.com",
        databaseURL: "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com",
        projectId: "jornalpsr-1b8c6",
    };

    firebase.initializeApp(firebaseConfig);
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const provider = new firebase.auth.GoogleAuthProvider();
    let AUTH_TOKEN = null;

    const DB_ROOT_URL = "https://jornalpsr-1b8c6-default-rtdb.firebaseio.com/";
    const CONTENT_URL = DB_ROOT_URL + "content.json";

    function criarBloqueio() {
        if(document.getElementById('login-overlay')) return;
        
        const div = document.createElement("div");
        div.id = "login-overlay";
        div.innerHTML = `
            <div class="login-box">
                <i class="fas fa-lock" style="font-size: 4rem; color: #DAA520; margin-bottom: 25px;"></i>
                <div class="login-title">Acesso Restrito</div>
                <p style="color:#666; margin-bottom:35px; line-height:1.5;">
                    Este painel √© exclusivo para administradores.<br>
                    Fa√ßa login para gerenciar o conte√∫do.
                </p>
                <button class="btn-login-google" onclick="fazerLogin()">
                    <i class="fab fa-google"></i> ENTRAR COM GOOGLE
                </button>
            </div>
        `;
        document.body.appendChild(div);
    }

    firebase.auth().onAuthStateChanged((user) => {
        const overlay = document.getElementById('login-overlay');
        const emailsPermitidos = ["marketingpsrimpressao@gmail.com", "rohsantos1@gmail.com"];
        
        if (user) {
            const emailUsuario = user.email ? user.email.toLowerCase() : "";

            if (emailUsuario && emailsPermitidos.includes(emailUsuario)) {
                console.log("Admin conectado:", emailUsuario);
                if(overlay) overlay.remove(); 
                
                user.getIdToken().then(token => {
                    AUTH_TOKEN = token;
                    showToast(`Bem-vindo(a), ${user.displayName || 'Admin'}!`, "success");
                    iniciarDashboard();
                });
            } else {
                alert("‚õî ACESSO NEGADO ‚õî\n\nO e-mail " + (emailUsuario || "Desconhecido") + " n√£o tem permiss√£o para acessar este painel.\n\nPor favor, entre com uma conta autorizada.");
                firebase.auth().signOut();
                criarBloqueio();
            }
        } else {
            criarBloqueio();
        }
    });

    function fazerLogin() {
        firebase.auth().signInWithPopup(provider).catch(erro => {
            console.error(erro);
            if(erro.code === 'auth/operation-not-supported-in-this-environment') {
                alert("‚ö†Ô∏è AVISO IMPORTANTE:\n\nO Google n√£o permite login abrindo o arquivo direto (clicando duas vezes).\n\nVoc√™ precisa rodar um 'Servidor Local' (Localhost) no seu computador para testar.");
            } else {
                alert("Erro no login: " + erro.message);
            }
        });
    }

    async function secureFetch(url, options = {}) {
        if (!AUTH_TOKEN) {
            const user = firebase.auth().currentUser;
            if (user) AUTH_TOKEN = await user.getIdToken();
        }
        
        if (!AUTH_TOKEN && options.method && options.method !== 'GET') {
            alert("Sess√£o inv√°lida. Recarregue a p√°gina e fa√ßa login novamente.");
            throw new Error("Sem token");
        }

        const separator = url.includes('?') ? '&' : '?';
        const finalUrl = AUTH_TOKEN ? `${url}${separator}auth=${AUTH_TOKEN}` : url;
        return fetch(finalUrl, options);
    }

    const CATEGORIES_MAP = {
        "A√ßougues": "ü•©", "Supermercados e Hipermercados": "üõí", "Padarias e Confeitarias": "ü•ñ",
        "Hortifrutis (Sacol√µes)": "üçé", "Restaurantes": "üçΩÔ∏è", "Bares e Casas Noturnas": "üçª",
        "Lanchonetes e Fast Food": "üçî", "Pizzarias e Delivery": "üçï", "Farm√°cias e Drogarias": "üíä",
        "Hospitais e Laborat√≥rios": "üè•", "Ind√∫stria Aliment√≠cia": "ü•´", "Ind√∫stria de Bebidas": "ü•§",
        "Ind√∫stria Farmac√™utica": "üß™", "Ind√∫stria de Cosm√©ticos": "üíÑ", "Ind√∫stria de Produtos de Limpeza": "üßπ",
        "Ind√∫stria Automotiva": "üöó", "Confec√ß√µes (Ind√∫stria T√™xtil)": "üëï", "Transportadoras e Log√≠stica": "üöö",
        "E-commerce": "üì¶", "Estacionamentos": "üÖøÔ∏è", "Postos de Combust√≠vel": "‚õΩ",
        "Shopping Centers": "üõçÔ∏è", "Condom√≠nios (Comerciais e Residenciais)": "üè¢", "Bancos e Financeiras": "üí∞"
    };
    const DADOS_PRE_CARREGADOS = { temaMes: { titulo: "Carregando..." } };

    function switchView(viewName) {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.remove('view-active'));
        
        if (viewName === 'content') {
            document.getElementById('view-content').classList.add('view-active');
            document.querySelector('.view-btn:nth-child(1)').classList.add('active');
            document.getElementById('editor-controls').style.display = 'block';
            document.querySelector('.save-bar').style.display = 'block';
        } else if (viewName === 'interactions') {
            document.getElementById('view-interactions').classList.add('view-active');
            document.querySelector('.view-btn:nth-child(2)').classList.add('active');
            document.getElementById('editor-controls').style.display = 'none';
            document.querySelector('.save-bar').style.display = 'none';
            if(!document.getElementById('monitor-filter-date').value) {
                const now = new Date();
                document.getElementById('monitor-filter-date').value = now.toISOString().slice(0, 7);
            }
            loadInteractions();
        } else if (viewName === 'traffic') {
            document.getElementById('view-traffic').classList.add('view-active');
            document.querySelector('.view-btn:nth-child(3)').classList.add('active');
            document.getElementById('editor-controls').style.display = 'none';
            document.querySelector('.save-bar').style.display = 'none';
            loadTrafficData();
        }
    }

    async function iniciarDashboard() {
        try {
            const resp = await secureFetch(CONTENT_URL);
            const data = await resp.json();
            const finalData = (data && data.temaMes) ? data : DADOS_PRE_CARREGADOS;
            populateForm(finalData);
        } catch (e) { populateForm(DADOS_PRE_CARREGADOS); }
        
        const listEl = document.getElementById('clientes-list');
        if(listEl) listEl.addEventListener('paste', handleClientPaste);
    }

    async function deleteRef(path) {
        if(!confirm("Tem certeza que deseja EXCLUIR este registro?")) return;
        try {
            await secureFetch(DB_ROOT_URL + path + ".json", { method: 'DELETE' });
            showToast("Registro exclu√≠do!", "success");
            loadInteractions();
        } catch(e) { showToast("Erro ao excluir.", "error"); }
    }

    async function deleteQuizUser(userId) {
        if(!confirm("Apagar hist√≥rico deste usu√°rio no Quiz?")) return;
        try {
            const resp = await secureFetch(DB_ROOT_URL + "safety_quiz.json");
            const data = await resp.json();
            if(data) {
                const promises = Object.keys(data).filter(qId => data[qId][userId]).map(qId => 
                    secureFetch(DB_ROOT_URL + `safety_quiz/${qId}/${userId}.json`, { method: 'DELETE' })
                );
                await Promise.all(promises);
            }
            showToast("Usu√°rio limpo do Quiz!", "success");
            loadInteractions();
        } catch(e) { showToast("Erro no quiz.", "error"); }
    }

    async function loadInteractions() {
        if(!AUTH_TOKEN) return;
        const filterDate = document.getElementById('monitor-filter-date').value; 
        
        try {
            const resp = await secureFetch(DB_ROOT_URL + ".json");
            const db = await resp.json();
            if(!db) return;

            const makeItem = (content, deletePath) => `
                <div class="monitor-item">
                    <div class="monitor-content">${content}</div>
                    <button class="btn-trash" onclick="deleteRef('${deletePath}')"><i class="fas fa-trash"></i></button>
                </div>`;

            let likesHtml = '';
            const histLikes = db.hobby_interactions_history?.[filterDate]?.likes;
            if(histLikes) Object.keys(histLikes).forEach(u => 
                likesHtml += makeItem(`${u} curtiu.`, `hobby_interactions_history/${filterDate}/likes/${u}`)
            );
            document.getElementById('monitor-hobby-likes').innerHTML = likesHtml || 'Zero.';

            let commHtml = '';
            if(db.hobby_interactions?.comments) Object.entries(db.hobby_interactions.comments).forEach(([k, v]) => {
                if(!v.date || v.date.startsWith(filterDate)) commHtml += makeItem(`<b>${v.author}:</b> ${v.text}`, `hobby_interactions/comments/${k}`);
            });
            document.getElementById('monitor-hobby-comments').innerHTML = commHtml || 'Zero.';

            let chalHtml = '';
            const histChal = db.challenges_history?.[filterDate];
            if(histChal) for(const [t, d] of Object.entries(histChal)) {
                chalHtml += `<b>${t}</b><br>`;
                Object.entries(d).forEach(([u, s]) => chalHtml += makeItem(`${u}: ${s}`, `challenges_history/${filterDate}/${t}/${u}`));
            }
            document.getElementById('monitor-challenges').innerHTML = chalHtml || 'Zero.';

            let quizHtml = '';
            if(db.safety_quiz) {
                let stats = {};
                for(let q in db.safety_quiz) for(let u in db.safety_quiz[q]) {
                    if(!stats[u]) stats[u] = {c:0, t:0};
                    stats[u].t++; if(db.safety_quiz[q][u]) stats[u].c++;
                }
                for(let u in stats) quizHtml += `<div class="monitor-item"><div>${u}<br><small>‚úÖ${stats[u].c} / ${stats[u].t}</small></div><button class="btn-trash" onclick="deleteQuizUser('${u}')"><i class="fas fa-trash"></i></button></div>`;
            }
            document.getElementById('monitor-quiz').innerHTML = quizHtml || 'Zero.';

            let praiseHtml = '';
            if(db.praise_messages) Object.entries(db.praise_messages).forEach(([k, v]) => {
                if(!v.date || v.date.startsWith(filterDate)) praiseHtml += makeItem(`De ${v.from} p/ ${v.to}: "${v.message}"`, `praise_messages/${k}`);
            });
            document.getElementById('monitor-praise').innerHTML = praiseHtml || 'Zero.';
            
            let gamesHtml = '';
            if(db.games) {
                for (const [gameName, gameData] of Object.entries(db.games)) {
                    if(gameData.scores) {
                        gamesHtml += `<div style="margin:10px 0 5px; font-weight:bold; color:var(--primary);">${gameName}</div>`;
                        Object.entries(gameData.scores).forEach(([key, s]) => {
                            let show = true;
                            if(s.data) {
                                const parts = s.data.split('/');
                                if(parts.length >= 3) {
                                    const gameMonth = parts[1];
                                    const gameYear = parts[2].split(',')[0].trim();
                                    if(`${gameYear}-${gameMonth}` !== filterDate) show = false;
                                }
                            }
                            if(show) gamesHtml += makeItem(`Rank: <b>${s.pontos}</b> - ${s.nome} <small>${s.data}</small>`, `games/${gameName}/scores/${key}`);
                        });
                    }
                }
            }
            document.getElementById('monitor-games').innerHTML = gamesHtml || 'Sem jogos no per√≠odo.';

            let suggHtml = '';
            const processSugg = (nodeName, label, formatFn) => {
                if(db[nodeName]) Object.entries(db[nodeName]).forEach(([key, s]) => {
                    if(s.date && !s.date.startsWith(filterDate)) return;
                    suggHtml += makeItem(`<strong style="color:#DAA520">${label}</strong> ${formatFn(s)} <small>${new Date(s.date).toLocaleString()}</small>`, `${nodeName}/${key}`);
                });
            };
            processSugg('hobby_suggestions', 'Hobby', s => `De ${s.from} indicando <b>${s.target}</b>: "${s.reason}"`);
            processSugg('game_suggestions', 'Game', s => `<b>${s.name}</b>: "${s.text}"`);
            processSugg('recipe_suggestions', 'Receita', s => `<b>${s.author}</b>: Prato "${s.dish}"`);
            document.getElementById('monitor-suggestions').innerHTML = suggHtml || 'Sem sugest√µes.';

            let rateHtml = '';
            const histRate = db.ratings_history?.[filterDate];
            if(histRate) for(const [itemId, votes] of Object.entries(histRate)) {
                rateHtml += `<div style="margin:10px 0 5px; font-weight:bold; color:var(--primary);">${itemId}</div>`;
                Object.entries(votes).forEach(([userId, stars]) => {
                    rateHtml += makeItem(`<span class="id-badge">${userId}</span> : ${stars} ‚≠ê`, `ratings_history/${filterDate}/${itemId}/${userId}`);
                });
            }
            document.getElementById('monitor-ratings').innerHTML = rateHtml || 'Sem avalia√ß√µes.';

            let commHtmlText = '';
            if(db.Comunicado) Object.entries(db.Comunicado).forEach(([k, c]) => commHtmlText += makeItem(`<b>${c["autor:"]}</b>: "${c["comunicado:"]}"`, `Comunicado/${k}`));
            if(db.Leituras_Confirmadas && db.Leituras_Confirmadas[0]) {
                commHtmlText += `<div style="margin-top:10px;"><strong>Leituras Confirmadas (IDs):</strong></div>`;
                Object.keys(db.Leituras_Confirmadas[0]).forEach(uid => commHtmlText += makeItem(`<span class="id-badge">${uid}</span> Leu.`, `Leituras_Confirmadas/0/${uid}`));
            }
            document.getElementById('monitor-comms').innerHTML = commHtmlText || 'Sem dados.';
             
        } catch(e) { console.error(e); }
    }

    let visitsChartInstance = null;
    let deviceChartInstance = null;
    let eventsChartInstance = null;

async function loadTrafficData() {
        if(!AUTH_TOKEN) return;
        
        try {
            const resp = await secureFetch(DB_ROOT_URL + "monitor_interno.json");
            const data = await resp.json() || {};
            
            // Data de hoje para os KPIs
            const hoje = new Date();
            const anoHoje = hoje.getFullYear();
            const mesHoje = String(hoje.getMonth() + 1).padStart(2, '0');
            const diaHoje = String(hoje.getDate()).padStart(2, '0');
            const hojeStr = `${anoHoje}-${mesHoje}-${diaHoje}`; // Formato YYYY-MM-DD
            
            // 1. KPI Visitas (Sem altera√ß√£o)
            const visitsToday = data.daily_visits && data.daily_visits[hojeStr] ? Object.keys(data.daily_visits[hojeStr]).length : 0;
            
            // 2. KPI Eventos (AJUSTADO: Ignora cliques em "x")
            let eventsToday = 0;
            if (data.events && data.events[hojeStr]) {
                // Filtra apenas eventos que N√ÉO sejam "x", "X" ou "fechar"
                eventsToday = Object.values(data.events[hojeStr]).filter(ev => {
                    const txt = (ev.txt || ev.id || "").toLowerCase().trim();
                    return txt !== 'x' && txt !== 'fechar' && txt !== 'close'; 
                }).length;
            }

            // 3. KPI Total Usu√°rios (Sem altera√ß√£o)
            const totalUsers = data.users ? Object.keys(data.users).length : 0;

            document.getElementById('kpi-visits').innerText = visitsToday;
            document.getElementById('kpi-events').innerText = eventsToday;
            document.getElementById('kpi-total-users').innerText = totalUsers;

            // --- L√ìGICA DO GR√ÅFICO (AJUSTADO: M√™s Vigente 01 a 30/31) ---
            const dates = [];
            const visitCounts = [];
            
            const currentYear = hoje.getFullYear();
            const currentMonth = hoje.getMonth(); // 0 = Janeiro
            
            // Descobre quantos dias tem o m√™s atual
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Loop do dia 1 at√© o √∫ltimo dia do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                // Monta a string da chave YYYY-MM-DD
                const dStr = String(day).padStart(2, '0');
                const mStr = String(currentMonth + 1).padStart(2, '0');
                const dbDateKey = `${currentYear}-${mStr}-${dStr}`;

                // Label para o gr√°fico (ex: 01/01)
                dates.push(`${dStr}/${mStr}`);

                // Pega o valor do banco ou 0 se n√£o existir
                const count = data.daily_visits && data.daily_visits[dbDateKey] ? Object.keys(data.daily_visits[dbDateKey]).length : 0;
                visitCounts.push(count);
            }
            
            renderVisitsChart(dates, visitCounts);
            // -------------------------------------------------------------

            // Gr√°fico de Dispositivos (Sem altera√ß√£o)
            let mobile = 0, desktop = 0;
            if(data.users) {
                Object.values(data.users).forEach(u => {
                    const info = (u.device_info || "").toLowerCase() + (u.platform || "").toLowerCase();
                    if(info.includes('mobile') || info.includes('android') || info.includes('iphone')) mobile++;
                    else desktop++;
                });
            }
            renderDeviceChart(mobile, desktop);

// Gr√°fico de Top Intera√ß√µes (Visitantes √önicos Di√°rios - Acumulado do M√™s Vigente)
            const eventCounts = {}; 

            // Pega o m√™s atual no formato YYYY-MM (ex: "2026-01") para filtrar
            const hojeData = new Date();
            const mesAtualStr = hojeData.toISOString().slice(0, 7); 

            if (data.events) {
                // Percorre cada dia que existe no banco de dados (chave = "YYYY-MM-DD")
                Object.keys(data.events).forEach(dateKey => {
                    
                    // FILTRO DE M√äS: S√≥ processa se o dia pertencer ao m√™s atual
                    if (dateKey.startsWith(mesAtualStr)) {
                        
                        const dayEvents = data.events[dateKey];
                        const dailyInteractionMap = {}; // Lista VIP deste dia espec√≠fico

                        Object.values(dayEvents).forEach(ev => {
                            const labelRaw = ev.txt || ev.id || "";
                            const labelParaFiltro = labelRaw.trim(); 
                            
                            // Pega o ID correto usando 'u' (conforme sua estrutura)
                            const userId = ev.u || ev.user || ev.uid || "anonimo"; 
                            
                            // Filtra o 'x', 'X' e o s√≠mbolo '√ó'
                            if (labelParaFiltro !== 'x' && labelParaFiltro !== 'X' && labelParaFiltro !== '√ó' && labelParaFiltro !== '') {
                                
                                if (!dailyInteractionMap[labelRaw]) {
                                    dailyInteractionMap[labelRaw] = new Set();
                                }
                                
                                // Adiciona na lista do dia (remove duplicatas do mesmo dia)
                                dailyInteractionMap[labelRaw].add(userId);
                            }
                        });

                        // Soma os √∫nicos DESTE DIA ao total do m√™s
                        for (const [label, userSet] of Object.entries(dailyInteractionMap)) {
                            eventCounts[label] = (eventCounts[label] || 0) + userSet.size; 
                        }
                    }
                });
            }

            // Ordena do maior para o menor e pega os top 5
            const sortedEvents = Object.entries(eventCounts)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 5);

            renderEventsChart(sortedEvents.map(e=>e[0]), sortedEvents.map(e=>e[1]));

        } catch(e) { console.error("Erro analytics:", e); }
    }

    function renderVisitsChart(labels, data) {
        const ctx = document.getElementById('chartVisits').getContext('2d');
        if(visitsChartInstance) visitsChartInstance.destroy();
        visitsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visitantes √önicos',
                    data: data,
                    borderColor: '#003366',
                    backgroundColor: 'rgba(0, 51, 102, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderDeviceChart(mob, desk) {
        const ctx = document.getElementById('chartDevices').getContext('2d');
        if(deviceChartInstance) deviceChartInstance.destroy();
        deviceChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Mobile/Tablet', 'Desktop'],
                datasets: [{
                    data: [mob, desk],
                    backgroundColor: ['#DAA520', '#003366']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderEventsChart(labels, data) {
        const ctx = document.getElementById('chartEvents').getContext('2d');
        if(eventsChartInstance) eventsChartInstance.destroy();
        eventsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cliques',
                    data: data,
                    backgroundColor: '#28a745',
                    borderRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
        });
    }

    function clearAllFields() {
        if (!confirm("Limpar tudo?")) return;
        document.querySelectorAll('input, textarea').forEach(el => el.value = "");
        document.getElementById('clientes-list').innerHTML = '';
        addNewClientRow();
    }
    
    function clearClientList() {
        if (!confirm("Limpar lista de clientes?")) return;
        document.getElementById('clientes-list').innerHTML = '';
        addNewClientRow();
    }
    
    function openTab(id, btn) {
        document.querySelectorAll('.tab-content, .tab-btn').forEach(c => c.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }
    
    function populateForm(data) {
        setVal('tema-titulo', data.temaMes?.titulo); setVal('tema-subtitulo', data.temaMes?.subtitulo); setVal('tema-resumo', data.temaMes?.resumo); setVal('tema-conteudo', data.temaMes?.conteudoCompleto); setVal('tema-fonte-nome', data.temaMes?.fonte?.texto); setVal('tema-fonte-link', data.temaMes?.fonte?.link);
        setVal('bemestar-subtitulo', data.saudeFisica?.subtitulo); setVal('bemestar-resumo', data.saudeFisica?.resumo); setVal('bemestar-conteudo', data.saudeFisica?.conteudoCompleto); setVal('bemestar-link', data.saudeFisica?.fonte?.link);
        setVal('hobby-nome', data.hobby?.nome); setVal('hobby-cargo', data.hobby?.cargo); setVal('hobby-foto', data.hobby?.foto); setVal('hobby-texto', data.hobby?.texto);
        if(data.hobby?.tags) { setVal('hobby-tag-1', data.hobby.tags[0]); setVal('hobby-tag-2', data.hobby.tags[1]); setVal('hobby-tag-3', data.hobby.tags[2]); }
        if(data.cultura && data.cultura[0]) populateCulture('cult-filme', data.cultura[0]);
        if(data.cultura && data.cultura[1]) populateCulture('cult-livro', data.cultura[1]);
        if(data.receitas && data.receitas[0]) { const r = data.receitas[0]; setVal('rec-emoji', r.emoji); setVal('rec-titulo', r.titulo); setVal('rec-tempo', r.tempo); setVal('rec-indicado', r.indicadoPor); setVal('rec-desc', r.desc); setVal('rec-ing', r.ingredientes ? r.ingredientes.join('; ') : ''); setVal('rec-prep', r.preparo ? r.preparo.join('; ') : ''); }
        if(data.desafios) { data.desafios.forEach((d, i) => { const idx = i + 1; if(idx <= 3) { setVal(`chal-${idx}-id`, d.id); setVal(`chal-${idx}-emoji`, d.emoji); setVal(`chal-${idx}-titulo`, d.titulo); setVal(`chal-${idx}-desc`, d.desc); } }); }
        setVal('clientes-qtd', data.novos_clientes?.resumo?.quantidade); setVal('clientes-periodo', data.novos_clientes?.resumo?.periodo);
        const listaClientes = data.novos_clientes?.lista || [];
        document.getElementById('clientes-list').innerHTML = ''; 
        if(listaClientes.length === 0) addNewClientRow(); else listaClientes.forEach(c => { let cat = Object.keys(CATEGORIES_MAP).find(key => CATEGORIES_MAP[key] === c.icone); addNewClientRow(cat, c.nome); });
    }
    
    function populateCulture(prefix, data) { setVal(`${prefix}-titulo`, data.titulo); setVal(`${prefix}-link`, data.link); setVal(`${prefix}-img`, data.img); setVal(`${prefix}-indicado`, data.indicadoPor); setVal(`${prefix}-sinopse`, data.sinopse); const cleanTag = data.tag ? data.tag.replace(/^Categoria:\s*/i, '') : ''; setVal(`${prefix}-tag`, cleanTag); }
    
    function addNewClientRow(selectedCat = "", name = "") { const container = document.getElementById('clientes-list'); const div = document.createElement('div'); div.className = 'client-row'; let options = '<option value="">Selecione...</option>'; for (const [cat, emoji] of Object.entries(CATEGORIES_MAP)) { const isSel = cat === selectedCat ? 'selected' : ''; options += `<option value="${cat}" ${isSel}>${cat}</option>`; } div.innerHTML = `<select class="client-select">${options}</select><div class="client-input-wrapper"><input type="text" class="client-input" value="${name}" placeholder="Nome do Cliente"><button type="button" class="client-remove" onclick="this.closest('.client-row').remove()"><i class="fas fa-trash-alt"></i></button></div>`; container.appendChild(div); }
    
    function handleClientPaste(e) { if (!e.target.classList.contains('client-input')) return; const pastedText = (e.clipboardData || window.clipboardData).getData('text'); if (!pastedText.includes('\n')) return; e.preventDefault(); const lines = pastedText.split(/\r?\n/).filter(line => line.trim() !== ''); const currentRow = e.target.closest('.client-row'); const currentCategory = currentRow.querySelector('.client-select').value; e.target.value = lines[0]; for (let i = 1; i < lines.length; i++) { addNewClientRow(currentCategory, lines[i]); } }
    
    function confirmSave() { 
        if(!AUTH_TOKEN) { alert("Fa√ßa login!"); return; }
        if (confirm("Publicar?")) { saveContent(); } 
    }
    
    async function saveContent() {
        const btn = document.querySelector('.btn-save'); btn.innerHTML = 'SALVANDO...'; btn.disabled = true;
        let existingData = {}; 
        try { 
            const getResp = await secureFetch(CONTENT_URL); existingData = await getResp.json() || {}; 
        } catch(e) {}

        const getValSafe = (id, existingVal) => { const el = document.getElementById(id); if (!el) return existingVal || ''; const val = el.value.trim(); return val !== '' ? val : (existingVal || ''); };
        
        const culturaArr = [{ id: getValSafe('cult-filme-id', existingData.cultura?.[0]?.id), tipo: 'video', titulo: getValSafe('cult-filme-titulo', existingData.cultura?.[0]?.titulo), link: getValSafe('cult-filme-link', existingData.cultura?.[0]?.link), img: getValSafe('cult-filme-img', existingData.cultura?.[0]?.img), indicadoPor: getValSafe('cult-filme-indicado', existingData.cultura?.[0]?.indicadoPor), sinopse: getValSafe('cult-filme-sinopse', existingData.cultura?.[0]?.sinopse), tag: getValSafe('cult-filme-tag', existingData.cultura?.[0]?.tag) }, { id: getValSafe('cult-livro-id', existingData.cultura?.[1]?.id), tipo: 'livro', titulo: getValSafe('cult-livro-titulo', existingData.cultura?.[1]?.titulo), link: getValSafe('cult-livro-link', existingData.cultura?.[1]?.link), img: getValSafe('cult-livro-img', existingData.cultura?.[1]?.img), indicadoPor: getValSafe('cult-livro-indicado', existingData.cultura?.[1]?.indicadoPor), sinopse: getValSafe('cult-livro-sinopse', existingData.cultura?.[1]?.sinopse), tag: getValSafe('cult-livro-tag', existingData.cultura?.[1]?.tag) }];
        const hobbyTags = [getVal('hobby-tag-1'), getVal('hobby-tag-2'), getVal('hobby-tag-3')].filter(t=>t); const finalHobbyTags = hobbyTags.length > 0 ? hobbyTags : (existingData.hobby?.tags || []);
        const receitaObj = { emoji: getValSafe('rec-emoji', existingData.receitas?.[0]?.emoji), titulo: getValSafe('rec-titulo', existingData.receitas?.[0]?.titulo), tempo: getValSafe('rec-tempo', existingData.receitas?.[0]?.tempo), indicadoPor: getValSafe('rec-indicado', existingData.receitas?.[0]?.indicadoPor), desc: getValSafe('rec-desc', existingData.receitas?.[0]?.desc), ingredientes: document.getElementById('rec-ing').value.trim() ? getVal('rec-ing').split(';').map(s=>s.trim()).filter(s=>s) : (existingData.receitas?.[0]?.ingredientes || []), preparo: document.getElementById('rec-prep').value.trim() ? getVal('rec-prep').split(';').map(s=>s.trim()).filter(s=>s) : (existingData.receitas?.[0]?.preparo || []) };
        const desafiosArr = [1, 2, 3].map(i => ({ id: getValSafe(`chal-${i}-id`, existingData.desafios?.[i-1]?.id), emoji: getValSafe(`chal-${i}-emoji`, existingData.desafios?.[i-1]?.emoji), titulo: getValSafe(`chal-${i}-titulo`, existingData.desafios?.[i-1]?.titulo), desc: getValSafe(`chal-${i}-desc`, existingData.desafios?.[i-1]?.desc) }));
        const clientRows = document.querySelectorAll('.client-row'); const clientesLista = Array.from(clientRows).map(row => { const cat = row.querySelector('.client-select').value; const nome = row.querySelector('.client-input').value; if(!nome) return null; return { icone: CATEGORIES_MAP[cat] || "üè¢", nome: nome, data: "", destaque: false }; }).filter(c => c !== null);
        const data = { temaMes: { titulo: getValSafe('tema-titulo', existingData.temaMes?.titulo), subtitulo: getValSafe('tema-subtitulo', existingData.temaMes?.subtitulo), resumo: getValSafe('tema-resumo', existingData.temaMes?.resumo), conteudoCompleto: getValSafe('tema-conteudo', existingData.temaMes?.conteudoCompleto), fonte: { texto: getValSafe('tema-fonte-nome', existingData.temaMes?.fonte?.texto), link: getValSafe('tema-fonte-link', existingData.temaMes?.fonte?.link) } }, saudeFisica: { subtitulo: getValSafe('bemestar-subtitulo', existingData.saudeFisica?.subtitulo), resumo: getValSafe('bemestar-resumo', existingData.saudeFisica?.resumo), conteudoCompleto: getValSafe('bemestar-conteudo', existingData.saudeFisica?.conteudoCompleto), fonte: { link: getValSafe('bemestar-link', existingData.saudeFisica?.fonte?.link), texto: "Fonte" } }, hobby: { nome: getValSafe('hobby-nome', existingData.hobby?.nome), cargo: getValSafe('hobby-cargo', existingData.hobby?.cargo), foto: getValSafe('hobby-foto', existingData.hobby?.foto), texto: getValSafe('hobby-texto', existingData.hobby?.texto), tags: finalHobbyTags }, cultura: culturaArr, receitas: [receitaObj], desafios: desafiosArr, novos_clientes: { resumo: { quantidade: getValSafe('clientes-qtd', existingData.novos_clientes?.resumo?.quantidade), periodo: getValSafe('clientes-periodo', existingData.novos_clientes?.resumo?.periodo) }, lista: clientesLista } };
        
        try { 
            const resp = await secureFetch(CONTENT_URL, { method: 'PUT', body: JSON.stringify(data) }); 
            if (resp.ok) showToast("Conte√∫do publicado com sucesso! ‚úÖ", "success"); 
            else throw new Error("Erro API"); 
        } catch (e) { 
            showToast("Erro ao salvar. Tente novamente.", "error"); 
        } finally { 
            btn.innerHTML = '<i class="fas fa-save"></i> PUBLICAR NO SITE'; btn.disabled = false; 
        }
    }

    function getVal(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
    function setVal(id, v) { if(document.getElementById(id)) document.getElementById(id).value = v || ''; }
    function showToast(msg, type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = type; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3500); }
</script>

</body>
</html>
