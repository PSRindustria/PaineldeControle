<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PSR - Marketing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#003366',
                        secondary: '#4682B4',
                        accent: '#FF8C00'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 3px solid #e5e7eb; border-top: 3px solid #003366; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Utilitários */
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .card-shadow:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // ============ CONFIGURAÇÕES ============
        // URL do Firebase (Base de leitura)
        const FIREBASE_URL = 'https://agenda-portal-2d149-default-rtdb.firebaseio.com/agenda.json';
        
        // URL do Google Apps Script (Para escrita: Aprovar/Comentar)
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzO7oR3CNBZD-NCnij7Xa-xScc09EWGU69uq81VDHPZmlmwjYJ4s_4rIYzy2Gp1iXvV/exec';

        // ============ MAPEAMENTO DE CAMPOS (CRUCIAL) ============
        // Estas chaves devem bater exatamente com os cabeçalhos do seu Excel/JSON
        const FIELD_KEYS = {
            TITLE: ['Título', 'Title', 'titulo'],
            // Como seu Excel não tem coluna "Assunto", usaremos "objetivo" ou "Plataforma" como secundário se necessário
            ASSUNTO: ['objetivo', 'Assunto', 'Objetivo'], 
            STATUS: ['Status', 'status'],
            // "Descrição" do Excel mapeia para a área de Observação/Detalhes do card
            OBSERVACAO: ['Descrição', 'Descricao', 'description', 'Observação'],
            APROVACAO: ['Aprovação', 'Aprovacao', 'aprovacao'],
            PLATAFORMA: ['Plataforma', 'Plataformas'],
            COMENTARIOS: ['comments', 'Comentários'],
            DATA_ENTREGA: ['Data de Entrega', 'Data Entrega', 'Prazo'],
            RESPONSAVEL: ['Responsável', 'Responsavel']
        };

        // ============ HELPERS ============
        function getFieldValue(item, possibleKeysArray, defaultValue = '') {
            if (!item) return defaultValue;
            for (const key of possibleKeysArray) {
                if (item[key] !== undefined && item[key] !== null && String(item[key]).trim() !== '') {
                    return item[key];
                }
            }
            return defaultValue;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Caso já seja objeto Date
            if (dateStr instanceof Date) return dateStr;
            
            // Tenta formato ISO (padrão JSON)
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;

            // Tenta formato BR (dd/mm/yyyy) vindo do Excel
            if (typeof dateStr === 'string' && dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // dia, mês (0-indexado), ano
                    d = new Date(parts[2], parseInt(parts[1]) - 1, parts[0]);
                    if (!isNaN(d.getTime())) return d;
                }
            }
            return null;
        }

        const formatDate = (dateInput) => {
            const d = parseDate(dateInput);
            if (!d) return 'Sem data';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        };

        const isOverdue = (dateStr, status) => {
            const d = parseDate(dateStr);
            if (!d) return false;
            const today = new Date();
            today.setHours(0,0,0,0);
            const s = String(status || '').toLowerCase();
            // Não considera atrasado se já estiver concluído/postado
            if (s.includes('conclu') || s.includes('final') || s.includes('postado')) return false;
            return d < today;
        };

        // ============ COMPONENTE DE ÍCONE ============
        const Icon = ({ name, className = "" }) => <i className={`fas fa-${name} ${className}`}></i>;

        // ============ APP PRINCIPAL ============
        function App() {
            const [tasks, setTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedTask, setSelectedTask] = useState(null);
            const [toast, setToast] = useState(null);
            
            // Filtros
            const [search, setSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterPlat, setFilterPlat] = useState('all');

            // Carregar Dados
            const loadData = useCallback(async () => {
                setLoading(true);
                try {
                    // Adiciona timestamp para evitar cache do navegador
                    const res = await fetch(`${FIREBASE_URL}?t=${new Date().getTime()}`);
                    const json = await res.json();
                    
                    let data = [];
                    if (Array.isArray(json)) {
                        data = json.filter(item => item !== null); // Remove entradas vazias
                    } else if (typeof json === 'object' && json !== null) {
                        data = Object.values(json);
                    }
                    
                    setTasks(data);
                } catch (err) {
                    console.error("Erro ao carregar:", err);
                    showToast('Erro ao carregar dados', 'error');
                } finally {
                    setLoading(false);
                }
            }, []);

            useEffect(() => { loadData(); }, [loadData]);

            // Mostrar Toast
            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 4000);
            };

            // Enviar para Google Sheets (JSONP Hack)
            const sendToScript = (action, payload) => {
                showToast('Processando...', 'loading');
                
                const scriptId = 'jsonp_callback_' + Math.round(100000 * Math.random());
                const params = new URLSearchParams({ 
                    action, 
                    callback: scriptId,
                    row: payload.row,
                    ...(payload.value && { value: payload.value }),
                    ...(payload.comment && { comment: payload.comment })
                });

                window[scriptId] = (data) => {
                    delete window[scriptId];
                    document.getElementById(scriptId).remove();
                    if (data.status === 'ok') {
                        showToast('Atualizado com sucesso!', 'success');
                        setTimeout(loadData, 1000); // Recarrega dados após 1s
                        if (action === 'addComment') {
                             // Atualização otimista local para feedback imediato no modal
                             if (selectedTask) {
                                const currentComments = getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS) || [];
                                const newComments = Array.isArray(currentComments) ? [...currentComments] : [];
                                const now = new Date();
                                const timeStr = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                                newComments.push(`[${timeStr}] ${payload.comment.replace(`[${timeStr}] `, '')}`);
                                
                                // Cria uma cópia da task atualizada
                                const updatedTask = { ...selectedTask };
                                // Atualiza a propriedade baseada na chave correta (comments)
                                updatedTask['comments'] = newComments; 
                                setSelectedTask(updatedTask);
                             }
                        } else {
                            setSelectedTask(null); // Fecha modal em aprovações
                        }
                    } else {
                        showToast('Erro na resposta do servidor', 'error');
                    }
                };

                const script = document.createElement('script');
                script.src = `${GOOGLE_SCRIPT_URL}?${params}`;
                script.id = scriptId;
                document.body.appendChild(script);
            };

            const handleApprove = (task, type) => {
                const row = task._row;
                if (!row) return showToast('Erro: Tarefa sem ID', 'error');

                const now = new Date();
                const timeStr = `${String(now.getDate()).padStart(2, "0")}/${String(now.getMonth() + 1).padStart(2, "0")} ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
                
                let value = '';
                if (type === 'approve') value = `Aprovado em ${timeStr}`;
                if (type === 'reject') value = `Reprovado em ${timeStr}`;
                
                sendToScript('updateI', { row, value });
            };

            const handleComment = (task) => {
                const text = prompt("Digite seu comentário:");
                if (!text) return;
                
                const now = new Date();
                const timeStr = `${String(now.getDate()).padStart(2, "0")}/${String(now.getMonth() + 1).padStart(2, "0")} ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
                
                sendToScript('addComment', { 
                    row: task._row, 
                    comment: `[${timeStr}] ${text}` 
                });
            };

            // Filtragem
            const filteredData = useMemo(() => {
                return tasks.filter(t => {
                    const title = String(getFieldValue(t, FIELD_KEYS.TITLE)).toLowerCase();
                    const desc = String(getFieldValue(t, FIELD_KEYS.OBSERVACAO)).toLowerCase();
                    const status = String(getFieldValue(t, FIELD_KEYS.STATUS));
                    const plat = String(getFieldValue(t, FIELD_KEYS.PLATAFORMA));
                    const sTerm = search.toLowerCase();

                    const matchSearch = title.includes(sTerm) || desc.includes(sTerm);
                    const matchStatus = filterStatus === 'all' || status === filterStatus;
                    const matchPlat = filterPlat === 'all' || plat === filterPlat;

                    return matchSearch && matchStatus && matchPlat;
                }).sort((a, b) => {
                    // Ordenar por data (mais recente primeiro se sem data, ou data mais próxima)
                    const da = parseDate(getFieldValue(a, FIELD_KEYS.DATA_ENTREGA));
                    const db = parseDate(getFieldValue(b, FIELD_KEYS.DATA_ENTREGA));
                    if (!da) return 1;
                    if (!db) return -1;
                    return da - db;
                });
            }, [tasks, search, filterStatus, filterPlat]);

            // Opções únicas para selects
            const uniqueStatus = [...new Set(tasks.map(t => getFieldValue(t, FIELD_KEYS.STATUS)))].filter(Boolean).sort();
            const uniquePlat = [...new Set(tasks.map(t => getFieldValue(t, FIELD_KEYS.PLATAFORMA)))].filter(Boolean).sort();

            // Status Styling Helper
            const getStatusColor = (status, approval) => {
                const s = String(status).toLowerCase();
                const a = String(approval).toLowerCase();
                
                if (a.includes('reprovado')) return 'bg-red-100 text-red-700 border-red-200';
                if (a.includes('aprovado')) return 'bg-green-100 text-green-700 border-green-200';
                
                if (s.includes('conclu') || s.includes('final') || s.includes('postado')) return 'bg-blue-100 text-blue-700 border-blue-200';
                if (s.includes('andamento') || s.includes('progresso')) return 'bg-amber-100 text-amber-700 border-amber-200';
                
                return 'bg-gray-100 text-gray-600 border-gray-200';
            };

            return (
                <div className="min-h-screen pb-20">
                    {/* TOAST */}
                    {toast && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-50 animate-fadeIn">
                            <div className={`px-6 py-3 rounded-full shadow-lg flex items-center gap-3 font-medium text-white ${
                                toast.type === 'error' ? 'bg-red-500' : 
                                toast.type === 'loading' ? 'bg-blue-600' : 'bg-green-600'
                            }`}>
                                {toast.type === 'loading' && <div className="loader !w-4 !h-4 !border-white/30 !border-t-white"></div>}
                                {toast.msg}
                            </div>
                        </div>
                    )}

                    {/* HEADER */}
                    <header className="glass-header sticky top-0 z-40 border-b border-gray-200 shadow-sm">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white shadow-lg shadow-primary/30">
                                        <Icon name="chart-simple" />
                                    </div>
                                    <h1 className="text-xl font-bold text-gray-800">Painel Marketing</h1>
                                </div>
                                
                                <div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                                    <div className="bg-white border rounded-lg flex items-center px-3 py-2 w-full md:w-64">
                                        <Icon name="search" className="text-gray-400 mr-2" />
                                        <input 
                                            type="text" 
                                            placeholder="Buscar tarefas..." 
                                            className="bg-transparent outline-none w-full text-sm"
                                            value={search}
                                            onChange={e => setSearch(e.target.value)}
                                        />
                                    </div>
                                    <button onClick={loadData} className="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition">
                                        <Icon name="rotate" className={loading ? "fa-spin" : ""} />
                                    </button>
                                </div>
                            </div>
                            
                            {/* Filters Row */}
                            <div className="flex gap-3 mt-4 overflow-x-auto pb-2 custom-scrollbar">
                                <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)} className="bg-white text-sm border border-gray-300 rounded-full px-4 py-1.5 outline-none hover:border-primary cursor-pointer">
                                    <option value="all">Todos Status</option>
                                    {uniqueStatus.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                                <select value={filterPlat} onChange={e => setFilterPlat(e.target.value)} className="bg-white text-sm border border-gray-300 rounded-full px-4 py-1.5 outline-none hover:border-primary cursor-pointer">
                                    <option value="all">Todas Plataformas</option>
                                    {uniquePlat.map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                        </div>
                    </header>

                    {/* KANBAN/GRID */}
                    <main className="container mx-auto px-4 py-8">
                        {loading && tasks.length === 0 ? (
                            <div className="text-center py-20 text-gray-400">
                                <div className="loader mx-auto mb-3"></div>
                                <p>Sincronizando tarefas...</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                {filteredData.map((task) => {
                                    const status = getFieldValue(task, FIELD_KEYS.STATUS, 'Pendente');
                                    const approval = getFieldValue(task, FIELD_KEYS.APROVACAO, '');
                                    const dateStr = getFieldValue(task, FIELD_KEYS.DATA_ENTREGA);
                                    const isLate = isOverdue(dateStr, status);
                                    const statusClass = getStatusColor(status, approval);

                                    return (
                                        <div 
                                            key={task._row} 
                                            onClick={() => setSelectedTask(task)}
                                            className="bg-white rounded-xl p-5 border border-gray-100 card-shadow cursor-pointer relative group transition-all hover:-translate-y-1 animate-fadeIn"
                                        >
                                            {/* Header Card */}
                                            <div className="flex justify-between items-start mb-3">
                                                <span className="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-gray-50 px-2 py-1 rounded">
                                                    {getFieldValue(task, FIELD_KEYS.PLATAFORMA, 'Geral')}
                                                </span>
                                                {isLate && (
                                                    <span className="text-[10px] font-bold bg-red-100 text-red-600 px-2 py-1 rounded flex items-center gap-1">
                                                        <Icon name="circle-exclamation" /> Atrasado
                                                    </span>
                                                )}
                                            </div>

                                            {/* Content */}
                                            <h3 className="font-bold text-gray-800 leading-tight mb-2 line-clamp-2">
                                                {getFieldValue(task, FIELD_KEYS.TITLE, 'Sem título')}
                                            </h3>
                                            
                                            {/* Footer Card */}
                                            <div className="mt-4 pt-3 border-t border-gray-50 flex justify-between items-center text-xs">
                                                <div className="flex items-center gap-2 text-gray-500">
                                                    <Icon name="calendar" />
                                                    {formatDate(dateStr)}
                                                </div>
                                                <div className={`px-2 py-1 rounded border font-semibold ${statusClass}`}>
                                                    {approval.includes('rovado') ? (approval.includes('Apro') ? 'Aprovado' : 'Reprovado') : status}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </main>

                    {/* MODAL DETALHES */}
                    {selectedTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fadeIn" onClick={() => setSelectedTask(null)}>
                            <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                                
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-100 flex justify-between items-start bg-gray-50">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="bg-white border px-2 py-0.5 rounded text-xs font-bold text-gray-500 uppercase">
                                                {getFieldValue(selectedTask, FIELD_KEYS.PLATAFORMA)}
                                            </span>
                                            <span className="text-xs text-gray-400">#{selectedTask._row}</span>
                                        </div>
                                        <h2 className="text-xl font-bold text-gray-900 leading-snug">
                                            {getFieldValue(selectedTask, FIELD_KEYS.TITLE)}
                                        </h2>
                                    </div>
                                    <button onClick={() => setSelectedTask(null)} className="text-gray-400 hover:text-gray-700 bg-white p-2 rounded-full shadow-sm hover:shadow transition">
                                        <Icon name="xmark" className="text-lg" />
                                    </button>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                                    
                                    {/* Status Bar */}
                                    <div className="flex flex-wrap gap-4 mb-6 p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                                        <div className="flex-1">
                                            <div className="text-xs text-blue-800 uppercase font-bold mb-1">Status</div>
                                            <div className="font-semibold text-gray-800 flex items-center gap-2">
                                                <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                                {getFieldValue(selectedTask, FIELD_KEYS.STATUS)}
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <div className="text-xs text-blue-800 uppercase font-bold mb-1">Aprovação</div>
                                            <div className={`font-semibold ${
                                                String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).includes('Repro') ? 'text-red-600' :
                                                String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).includes('Apro') ? 'text-green-600' : 'text-gray-500'
                                            }`}>
                                                {getFieldValue(selectedTask, FIELD_KEYS.APROVACAO) || 'Pendente'}
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <div className="text-xs text-blue-800 uppercase font-bold mb-1">Entrega</div>
                                            <div className="font-semibold text-gray-800">
                                                {formatDate(getFieldValue(selectedTask, FIELD_KEYS.DATA_ENTREGA))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* Description */}
                                    <div className="mb-8">
                                        <h3 className="text-sm font-bold text-gray-900 uppercase tracking-wide mb-3 flex items-center gap-2">
                                            <Icon name="align-left" className="text-gray-400" /> Descrição da Tarefa
                                        </h3>
                                        <div className="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap pl-6 border-l-2 border-gray-200">
                                            {getFieldValue(selectedTask, FIELD_KEYS.OBSERVACAO) || 'Sem descrição.'}
                                        </div>
                                    </div>

                                    {/* Comments */}
                                    <div>
                                        <h3 className="text-sm font-bold text-gray-900 uppercase tracking-wide mb-3 flex items-center gap-2">
                                            <Icon name="comments" className="text-gray-400" /> Histórico
                                        </h3>
                                        <div className="space-y-3 bg-gray-50 p-4 rounded-xl">
                                            {(() => {
                                                const rawComments = getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS);
                                                // Garante que é array, mesmo se vier string única ou undefined
                                                const commentsList = Array.isArray(rawComments) ? rawComments : (rawComments ? [rawComments] : []);
                                                
                                                if (commentsList.length === 0) return <p className="text-gray-400 text-sm italic text-center">Nenhum comentário.</p>;
                                                
                                                return commentsList.map((c, i) => (
                                                    <div key={i} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm text-sm text-gray-700">
                                                        {c}
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    </div>

                                </div>

                                {/* Footer Actions */}
                                <div className="p-4 bg-white border-t border-gray-200 grid grid-cols-3 gap-3">
                                    <button onClick={() => handleApprove(selectedTask, 'approve')} className="flex items-center justify-center gap-2 bg-green-50 text-green-700 hover:bg-green-100 font-semibold py-3 rounded-lg transition border border-green-200">
                                        <Icon name="thumbs-up" /> Aprovar
                                    </button>
                                    <button onClick={() => handleApprove(selectedTask, 'reject')} className="flex items-center justify-center gap-2 bg-red-50 text-red-700 hover:bg-red-100 font-semibold py-3 rounded-lg transition border border-red-200">
                                        <Icon name="thumbs-down" /> Reprovar
                                    </button>
                                    <button onClick={() => handleComment(selectedTask)} className="flex items-center justify-center gap-2 bg-primary text-white hover:bg-primary/90 font-semibold py-3 rounded-lg transition shadow-md shadow-primary/20">
                                        <Icon name="comment-dots" /> Comentar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
