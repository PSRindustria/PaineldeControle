<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PSR - Marketing</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2920/2920349.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#003366',   /* Azul Escuro Institucional */
                        secondary: '#4682B4', /* Azul Aço */
                        darkbanner: '#003366', /* Fundo do Banner */
                    },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInUp { animation: fadeInUp 0.5s ease-out forwards; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #003366;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15);
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const FIREBASE_URL = 'https://agenda-portal-2d149-default-rtdb.firebaseio.com/agenda.json';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzO7oR3CNBZD-NCnij7Xa-xScc09EWGU69uq81VDHPZmlmwjYJ4s_4rIYzy2Gp1iXvV/exec';

        const FIELD_KEYS = {
            TITLE: ['Título', 'Nome', 'Title', 'titulo'],
            ASSUNTO: ['objetivo', 'Objetivo', 'Assunto', 'assunto'], 
            STATUS: ['Status', 'Status:', 'status'],
            OBSERVACAO: ['Descrição', 'Descricao', 'Observação', 'Observacao', 'Observacão', 'observacao'],
            APROVACAO: ['Aprovação', 'Aprovacao', 'aprovacao'],
            PLATAFORMA: ['Plataforma', 'Plataformas', 'plataforma'],
            LINK_DRIVE: ['Link do Drive', 'Link Drive', 'Drive', 'link'],
            COMENTARIOS: ['comments', 'Comentários', 'Comentarios', 'comentarios'],
            DATA_POSTAGEM: ['Data da Postagem', 'Data Postagem', 'dataPostagem', 'Data:', 'data'],
            DATA_ENTREGA: ['Data de Entrega', 'Data Entrega', 'dataEntrega', 'Prazo', 'prazo'],
            PROGRESSO: ['Progresso (%)', 'Progresso', 'progresso', 'porcentagem']
        };

        function getFieldValue(item, possibleKeysArray, defaultValue = '') {
            if (!item) return defaultValue;
            for (const key of possibleKeysArray) {
                if (item.hasOwnProperty(key) && item[key] != null) {
                    if (typeof item[key] === 'string' && item[key].trim() === '') continue;
                    return item[key];
                }
            }
            return defaultValue;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            const isoDate = new Date(dateStr);
            if (!isNaN(isoDate.getTime()) && typeof dateStr === 'string' && dateStr.includes('-')) {
                return isoDate;
            }
            if (typeof dateStr === 'string') {
                try {
                    let d = null;
                    if (dateStr.includes('/')) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            d = new Date(parts[2], parseInt(parts[1])-1, parts[0]);
                        } else if (parts.length === 2) {
                            d = new Date(new Date().getFullYear(), parseInt(parts[1])-1, parts[0]);
                        }
                    } else if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
                        d = new Date(dateStr);
                    }
                    return (d && !isNaN(d.getTime())) ? d : null;
                } catch (e) { return null; }
            }
            return null;
        }

        const formatDate = (dateInput) => {
            const d = parseDate(dateInput);
            if (!d) return 'Sem data';
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        };

        const isDateOverdue = (dateStr) => {
            const d = parseDate(dateStr);
            if (!d) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return d < today;
        };

        const parseComments = (rawComments) => {
            if (!rawComments) return [];
            if (Array.isArray(rawComments)) return rawComments;
            if (typeof rawComments === 'string') return rawComments.split('\n').filter(c => c.trim() !== '');
            return [];
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            const iconMap = {
                'LayoutDashboard': 'fa-chart-line',
                'RefreshCw': 'fa-sync-alt',
                'Filter': 'fa-filter',
                'Eye': 'fa-eye',
                'EyeOff': 'fa-eye-slash',
                'Inbox': 'fa-inbox',
                'Calendar': 'fa-calendar-alt',
                'FileCheck': 'fa-file-check',
                'ArrowRight': 'fa-arrow-right',
                'X': 'fa-times',
                'Link': 'fa-link',
                'MessageSquare': 'fa-comments',
                'ThumbsUp': 'fa-thumbs-up',
                'ThumbsDown': 'fa-thumbs-down',
                'MessageCircle': 'fa-comment-dots',
                'Edit': 'fa-pen-to-square',
                'Check': 'fa-check',
                'CheckCircle2': 'fa-circle-check',
                'XCircle': 'fa-circle-xmark',
                'AlertTriangle': 'fa-triangle-exclamation',
                'Clock': 'fa-clock',
                'HelpCircle': 'fa-circle-question',
                'Loader': 'fa-spinner fa-spin',
                'ExternalLink': 'fa-external-link-alt',
                'Search': 'fa-search',
                'Battery': 'fa-battery-half',
                'Bolt': 'fa-bolt'
            };
            const faClass = iconMap[name] || 'fa-circle';
            return <i className={`fas ${faClass} ${className}`} style={{ fontSize: size }}></i>;
        };

        // ============ APLICAÇÃO ============
        function App() {
            const [rawTasks, setRawTasks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedTask, setSelectedTask] = useState(null);
            const [modalMessage, setModalMessage] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [filterMonth, setFilterMonth] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [filterPlatform, setFilterPlatform] = useState('all');
            const [showCompleted, setShowCompleted] = useState(false);

            const loadData = useCallback(async () => {
                setLoading(true);
                try {
                    const response = await fetch(FIREBASE_URL);
                    if (!response.ok) throw new Error('Erro ao conectar com Firebase');
                    
                    const json = await response.json();
                    
                    if (json && typeof json === 'object') {
                        const items = Object.entries(json)
                            .filter(([_, item]) => item !== null)
                            .map(([key, item]) => ({
                                ...item,
                                _internalId: item._internalId || key,
                                _row: item._row || key
                            }));
                        
                        setRawTasks(items);
                        
                        if (selectedTask) {
                            const updatedSelected = items.find(i => i._row === selectedTask._row);
                            if (updatedSelected) setSelectedTask(updatedSelected);
                        }

                        if (filterMonth === '') {
                            const now = new Date();
                            setFilterMonth(`${now.getFullYear()}-${now.getMonth()}`);
                        }
                        console.log(`✅ ${items.length} tarefas carregadas`);
                    } else {
                        setRawTasks([]);
                    }
                } catch (err) {
                    console.error("❌ Erro ao carregar dados:", err);
                    setModalMessage({ type: 'error', text: 'Erro ao carregar dados do Firebase' });
                    setTimeout(() => setModalMessage(null), 3000);
                } finally {
                    setLoading(false);
                }
            }, [filterMonth, selectedTask]);

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 300000);
                return () => clearInterval(interval);
            }, []);

            const { filteredTasks, stats, availableMonths, availablePlatforms, availableStatuses, globalProgress, currentMonthLabel } = useMemo(() => {
                let filtered = [...rawTasks];
                const statsCounter = { total: 0, pending: 0, inProgress: 0, completed: 0, overdue: 0 };
                const monthsSet = new Map();
                const platformsSet = new Set();
                const statusesSet = new Set();
                let totalProgressSum = 0;

                rawTasks.forEach(task => {
                    const s = getFieldValue(task, FIELD_KEYS.STATUS);
                    if (s) statusesSet.add(s);
                    const p = getFieldValue(task, FIELD_KEYS.PLATAFORMA);
                    if (p) {
                        p.split(',').forEach(x => {
                            const trimmed = x.trim();
                            if (trimmed) platformsSet.add(trimmed);
                        });
                    }
                    const d = parseDate(getFieldValue(task, FIELD_KEYS.DATA_ENTREGA));
                    if (d) {
                        const key = `${d.getFullYear()}-${d.getMonth()}`;
                        if (!monthsSet.has(key)) {
                            monthsSet.set(key, { 
                                value: key, 
                                label: d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase()),
                                sort: d.getTime()
                            });
                        }
                    }
                });

                if (searchTerm.trim()) {
                    const search = searchTerm.toLowerCase();
                    filtered = filtered.filter(t => {
                        const title = String(getFieldValue(t, FIELD_KEYS.TITLE)).toLowerCase();
                        const assunto = String(getFieldValue(t, FIELD_KEYS.ASSUNTO)).toLowerCase();
                        const obs = String(getFieldValue(t, FIELD_KEYS.OBSERVACAO)).toLowerCase();
                        return title.includes(search) || assunto.includes(search) || obs.includes(search);
                    });
                }

                if (filterMonth) {
                    const [year, month] = filterMonth.split('-').map(Number);
                    filtered = filtered.filter(t => {
                        const d = parseDate(getFieldValue(t, FIELD_KEYS.DATA_ENTREGA));
                        return d && d.getMonth() === month && d.getFullYear() === year;
                    });
                }

                if (filterStatus !== 'all') {
                    filtered = filtered.filter(t => getFieldValue(t, FIELD_KEYS.STATUS) === filterStatus);
                }

                if (filterPlatform !== 'all') {
                    filtered = filtered.filter(t => {
                        const p = getFieldValue(t, FIELD_KEYS.PLATAFORMA);
                        return p && p.includes(filterPlatform);
                    });
                }

                if (!showCompleted) {
                    filtered = filtered.filter(t => {
                        const s = String(getFieldValue(t, FIELD_KEYS.STATUS)).toLowerCase();
                        const a = String(getFieldValue(t, FIELD_KEYS.APROVACAO)).toLowerCase();
                        const isDone = (s.includes('conclu') || s.includes('finaliz') || s.includes('postado')) && a.includes('aprovado');
                        return !isDone;
                    });
                }

                filtered.forEach(t => {
                    const s = String(getFieldValue(t, FIELD_KEYS.STATUS)).toLowerCase();
                    const a = String(getFieldValue(t, FIELD_KEYS.APROVACAO)).toLowerCase();
                    const dateStr = getFieldValue(t, FIELD_KEYS.DATA_ENTREGA);
                    const rawP = getFieldValue(t, FIELD_KEYS.PROGRESSO, '0');
                    const pVal = parseInt(String(rawP).replace(/\D/g, '')) || 0;
                    
                    totalProgressSum += Math.min(100, Math.max(0, pVal));
                    statsCounter.total++;
                    
                    if (isDateOverdue(dateStr) && !s.includes('conclu') && !s.includes('finaliz')) {
                        statsCounter.overdue++;
                    }
                    if ((s.includes('conclu') || s.includes('finaliz') || s.includes('postado')) && a.includes('aprovado')) {
                        statsCounter.completed++;
                    } else if (s.includes('programado') || s.includes('andamento') || s.includes('fila') || s.includes('produção')) {
                        statsCounter.inProgress++;
                    } else {
                        statsCounter.pending++;
                    }
                });
                
                filtered.sort((a, b) => {
                    const da = parseDate(getFieldValue(a, FIELD_KEYS.DATA_ENTREGA)) || new Date(8640000000000000);
                    const db = parseDate(getFieldValue(b, FIELD_KEYS.DATA_ENTREGA)) || new Date(8640000000000000);
                    return da - db;
                });

                // Cálculo do Progresso Global (Média)
                const globalAvg = statsCounter.total > 0 ? Math.round(totalProgressSum / statsCounter.total) : 0;

                // Label do Mês Atual para o Título Mobile
                const currentMonthObj = Array.from(monthsSet.values()).find(m => m.value === filterMonth);
                const currentLabel = currentMonthObj ? currentMonthObj.label : "Todos os Períodos";

                return {
                    filteredTasks: filtered,
                    stats: statsCounter,
                    globalProgress: globalAvg,
                    currentMonthLabel: currentLabel,
                    availableMonths: Array.from(monthsSet.values()).sort((a, b) => b.sort - a.sort),
                    availablePlatforms: Array.from(platformsSet).sort(),
                    availableStatuses: Array.from(statusesSet).sort()
                };
            }, [rawTasks, filterMonth, filterStatus, filterPlatform, showCompleted, searchTerm]);

            const sendDataToSheet = (payload, successMsg) => {
                setModalMessage({ type: 'loading', text: 'Enviando dados...' });
                const params = new URLSearchParams();
                params.set('action', payload.action);
                params.set('row', payload.row);
                if (payload.action === 'addComment') params.set('comment', payload.comment);
                if (payload.action === 'updateI') params.set('value', payload.value);
                const cbName = 'jsonpCallback_' + Math.random().toString(36).substr(2, 9);
                params.set('callback', cbName);

                window[cbName] = function(resp) {
                    if (resp && resp.status === 'ok') {
                        setModalMessage({ type: 'success', text: successMsg });
                        if (payload.action === 'addComment' && selectedTask) {
                             const currentComments = parseComments(getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS));
                             const updatedTask = { ...selectedTask };
                             updatedTask['comments'] = [...currentComments, payload.comment];
                             setSelectedTask(updatedTask);
                        }
                        setTimeout(() => {
                            setModalMessage(null);
                            if (payload.action !== 'addComment') setSelectedTask(null);
                            loadData();
                        }, 1500);
                    } else {
                        setModalMessage({ type: 'error', text: resp?.message || 'Erro ao processar solicitação' });
                        setTimeout(() => setModalMessage(null), 4000);
                    }
                    delete window[cbName];
                    const scriptEl = document.getElementById(cbName);
                    if (scriptEl) scriptEl.remove();
                };

                const script = document.createElement('script');
                script.id = cbName;
                script.src = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
                script.onerror = () => {
                    setModalMessage({ type: 'error', text: 'Erro de conexão com Google Apps Script. Verifique a URL.' });
                    setTimeout(() => setModalMessage(null), 4000);
                    delete window[cbName];
                };
                document.body.appendChild(script);
            };

            const handleApprove = (task, action) => {
                const row = task._row;
                if (!row) { alert("❌ Erro: ID da linha não encontrado."); return; }
                const now = new Date();
                const timeStr = `${String(now.getDate()).padStart(2, "0")}/${String(now.getMonth() + 1).padStart(2, "0")} às ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
                let val = '';
                if (action === 'approve') val = `Aprovado em ${timeStr}`;
                else if (action === 'reject') val = `Reprovado em ${timeStr}`;
                else if (action === 'pending') val = 'Pendente';
                else if (action === 'custom') {
                    const userVal = prompt("Digite o status de aprovação personalizado:", "Aprovado com ressalvas");
                    if (!userVal || !userVal.trim()) return;
                    val = `${userVal.trim()} - ${timeStr}`;
                }
                sendDataToSheet({ action: "updateI", row: row, value: val }, "✅ Status de aprovação atualizado!");
            };

            const handleComment = (task) => {
                const row = task._row;
                if (!row) { alert("❌ Erro: ID da linha não encontrado."); return; }
                const text = prompt("Digite seu comentário:");
                if (!text || !text.trim()) return;
                const now = new Date();
                const timestamp = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                sendDataToSheet({ action: 'addComment', row: row, comment: `[${timestamp}] ${text.trim()}` }, "✅ Comentário adicionado!");
            };

            const getStatusStyle = (status, approval) => {
                const s = String(status).toLowerCase();
                const a = String(approval).toLowerCase();
                if (a.includes('reprovado')) return { bg: 'bg-red-100', text: 'text-red-700', icon: 'XCircle' };
                if (a.includes('aprovado') || s.includes('aprovado')) return { bg: 'bg-green-100', text: 'text-green-700', icon: 'CheckCircle2' };
                if (s.includes('conclu') || s.includes('final') || s.includes('postado')) return { bg: 'bg-blue-100', text: 'text-blue-700', icon: 'Check' };
                if (s.includes('pendente') || s.includes('aguardando')) return { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'Clock' };
                if (s.includes('andamento') || s.includes('fila') || s.includes('produção') || s.includes('programado')) return { bg: 'bg-indigo-100', text: 'text-indigo-700', icon: 'Loader' };
                return { bg: 'bg-gray-200', text: 'text-gray-700', icon: 'HelpCircle' };
            };

            // ============ RENDERIZAÇÃO ============
            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-20">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold text-primary flex items-center gap-3">
                                        <Icon name="LayoutDashboard" size={28} className="text-secondary" />
                                        Painel Marketing PSR
                                    </h1>
                                    <p className="text-sm text-gray-500 mt-1">
                                        Gerenciamento de tarefas e aprovações
                                    </p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button 
                                        onClick={() => setShowCompleted(!showCompleted)}
                                        className={`px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all ${
                                            showCompleted 
                                                ? 'bg-primary text-white shadow-sm' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        <Icon name={showCompleted ? "Eye" : "EyeOff"} size={16} />
                                        <span className="hidden md:inline">{showCompleted ? "Ocultar Concluídas" : "Mostrar Concluídas"}</span>
                                        <span className="md:hidden">{showCompleted ? "Ocultar" : "Mostrar"}</span>
                                    </button>
                                    {loading && <div className="loader w-5 h-5 border-2"></div>}
                                    <button onClick={loadData} disabled={loading} className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-sm border border-gray-200">
                                        <Icon name="RefreshCw" size={20} className={loading ? "fa-spin" : ""} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* --- KPIS COM BATERIA DE PROGRESSO --- */}
                    <section className="bg-darkbanner text-white shadow-md">
                        <div className="container mx-auto px-4 py-8">
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                    <div className="text-xs uppercase tracking-wide text-white mb-1 font-semibold opacity-100">Total</div>
                                    <div className="text-3xl font-bold">{stats.total}</div>
                                </div>
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                    <div className="text-xs uppercase tracking-wide text-white mb-1 font-semibold opacity-100">Pendentes</div>
                                    <div className="text-3xl font-bold">{stats.pending}</div>
                                </div>
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                    <div className="text-xs uppercase tracking-wide text-white mb-1 font-semibold opacity-100">Em Andamento</div>
                                    <div className="text-3xl font-bold">{stats.inProgress}</div>
                                </div>
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                    <div className="text-xs uppercase tracking-wide text-white mb-1 font-semibold opacity-100">Concluídas</div>
                                    <div className="text-3xl font-bold">{stats.completed}</div>
                                </div>
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                    <div className="text-xs uppercase tracking-wide text-white mb-1 font-semibold opacity-100">Atrasadas</div>
                                    <div className="text-3xl font-bold text-red-300">{stats.overdue}</div>
                                </div>
                                
                                {/* BATERIA VERTICAL (NOVO CARD) */}
                                <div className="bg-white/10 backdrop-blur-sm rounded-lg p-2 border border-white/20 flex flex-col items-center justify-center relative overflow-hidden group">
                                    <div className="text-[10px] uppercase tracking-wide text-white mb-1 font-semibold text-center">Progresso Geral</div>
                                    <div className="relative w-6 h-10 border border-white/50 rounded-md p-0.5">
                                        <div className="absolute top-[-3px] left-1/2 -translate-x-1/2 w-2 h-0.5 bg-white/50 rounded-t-sm"></div>
                                        <div 
                                            className={`w-full rounded-sm absolute bottom-0.5 left-0.5 right-0.5 transition-all duration-1000 ${
                                                globalProgress === 100 ? 'bg-green-400' : 
                                                globalProgress > 60 ? 'bg-green-500' :
                                                globalProgress > 30 ? 'bg-yellow-400' : 'bg-red-400'
                                            }`}
                                            style={{ height: `${globalProgress}%`, maxHeight: 'calc(100% - 4px)' }}
                                        ></div>
                                    </div>
                                    <div className="font-bold text-white text-sm mt-1">{globalProgress}%</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* --- FILTROS OTIMIZADOS MOBILE --- */}
                    <section className="bg-white py-6 border-b border-gray-200 sticky top-[88px] z-10 shadow-sm">
                        <div className="container mx-auto px-4">
                            <div className="mb-4">
                                <div className="relative">
                                    <Icon name="Search" size={18} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                                    <input type="text" placeholder="Buscar por título..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition" />
                                </div>
                            </div>
                            
                            {/* Container Filtros: Flex Col no mobile, Flex Row no desktop */}
                            <div className="flex flex-col md:flex-row gap-3 items-start md:items-center justify-between">
                                <div className="flex flex-col md:flex-row flex-wrap items-center gap-3 w-full md:w-auto">
                                    
                                    {/* Label do Filtro (Dinâmico no Mobile) */}
                                    <div className="flex items-center gap-2 text-gray-600 w-full md:w-auto mb-2 md:mb-0">
                                        <Icon name="Filter" size={18} />
                                        {/* Mobile Title */}
                                        <span className="font-bold text-lg md:text-sm md:font-medium block md:hidden">Filtros: {currentMonthLabel}</span>
                                        {/* Desktop Title */}
                                        <span className="hidden md:block font-medium text-sm">Filtros:</span>
                                    </div>
                                    
                                    {/* Seletor de Mês (100% no mobile) */}
                                    <select 
                                        className="w-full md:w-auto px-3 py-3 md:py-2 rounded-lg border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none transition cursor-pointer font-medium" 
                                        value={filterMonth} 
                                        onChange={(e) => setFilterMonth(e.target.value)}
                                    >
                                        <option value="">Todos os Meses</option>
                                        {availableMonths.map(m => (<option key={m.value} value={m.value}>{m.label}</option>))}
                                    </select>

                                    {/* Seletor de Status (100% no mobile) */}
                                    <select 
                                        className="w-full md:w-auto px-3 py-3 md:py-2 rounded-lg border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none cursor-pointer" 
                                        value={filterStatus} 
                                        onChange={(e) => setFilterStatus(e.target.value)}
                                    >
                                        <option value="all">Todos os Status</option>
                                        {availableStatuses.map(s => (<option key={s} value={s}>{s}</option>))}
                                    </select>

                                    {/* Seletor de Plataforma (100% no mobile) */}
                                    <select 
                                        className="w-full md:w-auto px-3 py-3 md:py-2 rounded-lg border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-primary outline-none cursor-pointer" 
                                        value={filterPlatform} 
                                        onChange={(e) => setFilterPlatform(e.target.value)}
                                    >
                                        <option value="all">Todas as Plataformas</option>
                                        {availablePlatforms.map(p => (<option key={p} value={p}>{p}</option>))}
                                    </select>
                                </div>
                                
                                {(searchTerm || filterMonth || filterStatus !== 'all' || filterPlatform !== 'all') && (
                                    <button 
                                        onClick={() => { setSearchTerm(''); setFilterMonth(''); setFilterStatus('all'); setFilterPlatform('all'); }} 
                                        className="w-full md:w-auto px-6 py-3 md:py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition shadow-sm font-medium mt-2 md:mt-0"
                                    >
                                        Limpar Filtros
                                    </button>
                                )}
                            </div>
                        </div>
                    </section>

                    {/* --- GRID DE TAREFAS --- */}
                    <main className="container mx-auto px-4 py-8">
                        {loading && rawTasks.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-20 animate-fadeInUp">
                                <div className="loader mb-4"></div>
                                <p className="text-gray-600 font-medium">Carregando tarefas...</p>
                                <p className="text-sm text-gray-400 mt-2">Sincronizando com o banco de dados</p>
                            </div>
                        ) : filteredTasks.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed border-gray-300 animate-fadeInUp">
                                <Icon name="Inbox" size={64} className="mx-auto text-gray-300 mb-4" />
                                <h3 className="text-xl font-semibold text-gray-900 mb-2">Nenhuma tarefa encontrada</h3>
                                <p className="text-gray-500 mb-4">
                                    {searchTerm ? 'Tente ajustar sua busca ou' : 'Tente ajustar os'} filtros acima
                                </p>
                            </div>
                        ) : (
                            <>
                                <div className="mb-4 text-sm text-gray-500 flex justify-between items-center">
                                    <span>Exibindo <span className="font-bold text-primary">{filteredTasks.length}</span> tarefa(s)</span>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredTasks.map((task, index) => {
                                        const status = getFieldValue(task, FIELD_KEYS.STATUS, 'Sem Status');
                                        const approval = getFieldValue(task, FIELD_KEYS.APROVACAO, 'Pendente');
                                        const title = getFieldValue(task, FIELD_KEYS.TITLE, 'Sem Título');
                                        const platform = getFieldValue(task, FIELD_KEYS.PLATAFORMA, 'Geral');
                                        const dueDate = getFieldValue(task, FIELD_KEYS.DATA_ENTREGA);
                                        const isOverdue = isDateOverdue(dueDate) && !status.toLowerCase().includes('conclu') && !status.toLowerCase().includes('finaliz');
                                        const rawProgress = getFieldValue(task, FIELD_KEYS.PROGRESSO, '0');
                                        const progressNum = parseInt(String(rawProgress).replace(/\D/g, '')) || 0;
                                        const progress = Math.min(100, Math.max(0, progressNum));
                                        const style = getStatusStyle(status, approval);
                                        
                                        return (
                                            <div 
                                                key={task._internalId}
                                                onClick={() => setSelectedTask(task)}
                                                className="card-hover bg-white rounded-xl border border-gray-200 cursor-pointer group relative overflow-hidden flex flex-col h-full animate-fadeInUp"
                                                style={{ animationDelay: `${index * 50}ms` }}
                                            >
                                                <div className={`w-full py-2 flex items-center justify-center gap-2 font-bold text-xs uppercase tracking-wider ${style.bg} ${style.text}`}>
                                                    <Icon name={style.icon} size={12} />
                                                    {status}
                                                </div>

                                                {isOverdue && (
                                                    <div className="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold px-3 py-2 rounded-bl-lg shadow-md z-10 flex items-center gap-1">
                                                        <Icon name="AlertTriangle" size={10} />
                                                        ATRASADA
                                                    </div>
                                                )}
                                                
                                                <div className="p-5 flex flex-col flex-grow">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <span className="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-gray-100 px-2 py-1 rounded-md border border-gray-200">
                                                            {platform}
                                                        </span>
                                                    </div>
                                                    <h3 className="text-base font-bold text-gray-900 mb-4 leading-snug line-clamp-2 flex-grow">
                                                        {title}
                                                    </h3>

                                                    {progress > 0 && (
                                                        <div className="mb-4">
                                                            <div className="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                                                                <span className="flex items-center gap-1"><Icon name="Battery" size={10}/> Progresso</span>
                                                                <span>{progress}%</span>
                                                            </div>
                                                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden border border-gray-100">
                                                                <div className="bg-green-500 h-2 rounded-full transition-all duration-500 shadow-sm" style={{ width: `${progress}%` }}></div>
                                                            </div>
                                                        </div>
                                                    )}

                                                    <div className="space-y-2 text-xs border-t border-gray-100 pt-3 mt-auto">
                                                        <div className="flex items-center gap-2 text-gray-600">
                                                            <Icon name="Calendar" size={12} className="text-gray-400" />
                                                            <span className={isOverdue ? "font-bold text-red-600" : "font-medium"}>
                                                                Entrega: {formatDate(dueDate)}
                                                            </span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <Icon name="FileCheck" size={12} className="text-gray-400" />
                                                            <span className={`font-semibold ${
                                                                approval.toLowerCase().includes('reprovado') 
                                                                    ? 'text-red-600' 
                                                                    : approval.toLowerCase().includes('aprovado')
                                                                    ? 'text-green-600'
                                                                    : 'text-yellow-600'
                                                            }`}>
                                                                {approval}
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <div className="mt-3 pt-2 flex justify-end items-center text-xs text-primary font-bold opacity-0 group-hover:opacity-100 transition-opacity transform translate-y-2 group-hover:translate-y-0">
                                                        <span>Ver detalhes</span>
                                                        <Icon name="ArrowRight" size={12} className="ml-1" />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </>
                        )}
                    </main>

                    {/* --- MODAL --- */}
                    {selectedTask && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 modal-backdrop" onClick={() => setSelectedTask(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col animate-fadeInUp" onClick={e => e.stopPropagation()}>
                                <div className="p-6 bg-gradient-to-r from-primary to-secondary text-white flex justify-between items-start sticky top-0 z-10 shrink-0">
                                    <div className="flex-1 pr-4">
                                        <div className="flex flex-wrap gap-2 mb-3">
                                            <span className="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide border border-white/10">{getFieldValue(selectedTask, FIELD_KEYS.PLATAFORMA)}</span>
                                            <span className="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold border border-white/10">ID: {selectedTask._row || 'N/A'}</span>
                                        </div>
                                        <h2 className="text-xl md:text-2xl font-bold leading-tight">{getFieldValue(selectedTask, FIELD_KEYS.TITLE)}</h2>
                                    </div>
                                    <button onClick={() => setSelectedTask(null)} className="text-white/80 hover:text-white transition p-2 hover:bg-white/10 rounded-lg"><Icon name="X" size={24} /></button>
                                </div>

                                <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-gray-50/50">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div className="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                                            <div className="text-xs uppercase tracking-wide text-gray-500 mb-2 font-bold">Status Atual</div>
                                            <div className="font-bold text-gray-900 text-lg flex items-center gap-2">
                                                <Icon name={getStatusStyle(getFieldValue(selectedTask, FIELD_KEYS.STATUS), '').icon} size={20} className="text-primary" />
                                                {getFieldValue(selectedTask, FIELD_KEYS.STATUS)}
                                            </div>
                                        </div>
                                        <div className={`p-4 rounded-xl border shadow-sm ${String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('reprovado') ? 'bg-red-50 border-red-200' : String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('aprovado') ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                                            <div className="text-xs uppercase tracking-wide mb-2 font-bold opacity-80">Aprovação</div>
                                            <div className={`font-bold text-lg flex items-center gap-2 ${String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('reprovado') ? 'text-red-700' : String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('aprovado') ? 'text-green-700' : 'text-yellow-700'}`}>
                                                <Icon name={String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('reprovado') ? 'XCircle' : String(getFieldValue(selectedTask, FIELD_KEYS.APROVACAO)).toLowerCase().includes('aprovado') ? 'CheckCircle2' : 'Clock'} size={20} />
                                                {getFieldValue(selectedTask, FIELD_KEYS.APROVACAO) || 'Pendente'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {(() => {
                                        const rawProgress = getFieldValue(selectedTask, FIELD_KEYS.PROGRESSO, '0');
                                        const progressNum = parseInt(String(rawProgress).replace(/\D/g, '')) || 0;
                                        const progress = Math.min(100, Math.max(0, progressNum));
                                        
                                        if (progress > 0) return (
                                            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6">
                                                <div className="flex justify-between text-xs font-bold text-gray-500 mb-2">
                                                    <span className="flex items-center gap-1"><Icon name="Battery" size={12} className="text-gray-400"/> Progresso da Tarefa</span>
                                                    <span>{progress}%</span>
                                                </div>
                                                <div className="w-full bg-gray-100 rounded-full h-3 border border-gray-100 overflow-hidden">
                                                    <div className="bg-green-500 h-3 rounded-full shadow-sm" style={{ width: `${progress}%` }}></div>
                                                </div>
                                            </div>
                                        );
                                    })()}

                                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <h4 className="font-bold text-gray-900 mb-1 text-sm flex items-center gap-2">
                                                    <Icon name="MessageSquare" size={14} className="text-primary" /> Objetivo / Assunto
                                                </h4>
                                                <p className="text-sm text-gray-600 pl-6">{getFieldValue(selectedTask, FIELD_KEYS.ASSUNTO) || 'Não especificado'}</p>
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-gray-900 mb-1 text-sm flex items-center gap-2">
                                                    <Icon name="Calendar" size={14} className="text-primary" /> Data de Entrega
                                                </h4>
                                                <p className={`text-sm pl-6 font-medium ${isDateOverdue(getFieldValue(selectedTask, FIELD_KEYS.DATA_ENTREGA)) ? 'text-red-600' : 'text-gray-600'}`}>
                                                    {formatDate(getFieldValue(selectedTask, FIELD_KEYS.DATA_ENTREGA))}
                                                    {isDateOverdue(getFieldValue(selectedTask, FIELD_KEYS.DATA_ENTREGA)) && <span className="ml-2 text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold">ATRASADA</span>}
                                                </p>
                                            </div>
                                            <div className="md:col-span-2">
                                                <h4 className="font-bold text-gray-900 mb-1 text-sm flex items-center gap-2">
                                                    <Icon name="Link" size={14} className="text-primary" /> Link do Drive
                                                </h4>
                                                <div className="pl-6">
                                                    {getFieldValue(selectedTask, FIELD_KEYS.LINK_DRIVE) ? (
                                                        <a href={getFieldValue(selectedTask, FIELD_KEYS.LINK_DRIVE)} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 hover:underline font-medium transition bg-blue-50 px-3 py-1.5 rounded-md border border-blue-100"><Icon name="ExternalLink" size={12} /> Abrir arquivo no Google Drive</a>
                                                    ) : (<span className="text-sm text-gray-400 italic">Nenhum link fornecido</span>)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <h4 className="font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide">Descrição da Tarefa</h4>
                                        <div className="bg-white p-4 rounded-xl border border-gray-200 text-sm text-gray-700 leading-relaxed whitespace-pre-wrap shadow-sm">{getFieldValue(selectedTask, FIELD_KEYS.OBSERVACAO) || 'Sem descrição registrada.'}</div>
                                    </div>

                                    <div>
                                        <h4 className="font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide flex items-center gap-2">
                                            <Icon name="MessageCircle" size={16} /> Histórico de Comentários
                                        </h4>
                                        <div className="bg-gray-100/50 rounded-xl border border-gray-200 p-4 max-h-48 overflow-y-auto custom-scrollbar">
                                            {(() => {
                                                const commentsList = parseComments(getFieldValue(selectedTask, FIELD_KEYS.COMENTARIOS));
                                                if (commentsList.length > 0) {
                                                    return (
                                                        <div className="space-y-3">
                                                            {commentsList.map((comment, i) => (
                                                                <div key={i} className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm text-sm text-gray-700 relative pl-4 border-l-4 border-l-secondary">{comment}</div>
                                                            ))}
                                                        </div>
                                                    );
                                                } else {
                                                    return (<div className="text-center py-6 text-gray-400 text-sm italic">Nenhum comentário registrado.</div>);
                                                }
                                            })()}
                                        </div>
                                    </div>
                                </div>

                                <div className="p-4 border-t border-gray-200 bg-white shrink-0">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <button onClick={() => handleApprove(selectedTask, 'approve')} className="btn-action bg-green-600 text-white hover:bg-green-700 shadow-sm flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition"><Icon name="ThumbsUp" size={18} /> <span className="hidden sm:inline">Aprovar</span></button>
                                        <button onClick={() => handleApprove(selectedTask, 'reject')} className="btn-action bg-red-600 text-white hover:bg-red-700 shadow-sm flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition"><Icon name="ThumbsDown" size={18} /> <span className="hidden sm:inline">Reprovar</span></button>
                                        <button onClick={() => handleComment(selectedTask)} className="btn-action bg-primary text-white hover:bg-primary/90 shadow-sm flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition"><Icon name="MessageCircle" size={18} /> <span className="hidden sm:inline">Comentar</span></button>
                                        <button onClick={() => handleApprove(selectedTask, 'custom')} className="btn-action bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300 shadow-sm flex items-center justify-center gap-2 py-3 rounded-lg font-medium transition"><Icon name="Edit" size={18} /> <span className="hidden sm:inline">Customizar</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- TOAST --- */}
                    {modalMessage && (
                        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[100] animate-slideIn">
                            <div className={`px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-medium text-white min-w-[300px] justify-center ${
                                modalMessage.type === 'loading' ? 'bg-primary' : 
                                modalMessage.type === 'error' ? 'bg-red-600' : 'bg-green-600'
                            }`}>
                                {modalMessage.type === 'loading' && <div className="w-4 h-4 border-2 border-white/40 border-t-white rounded-full animate-spin"></div>}
                                {modalMessage.type === 'success' && <Icon name="CheckCircle2" size={20} />}
                                {modalMessage.type === 'error' && <Icon name="AlertTriangle" size={20} />}
                                <span>{modalMessage.text}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
