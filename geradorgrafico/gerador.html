<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Dashboard - PSR (Vendido+Faturado)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* --- RESET E ESTILOS GERAIS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            background-color: #ffffff !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        /* --- ANIMA√á√ÉO DE PULSO --- */
        @keyframes pulse-green {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .btn-attention {
            animation: pulse-green 1.5s infinite;
            background-color: #059669 !important;
        }

        /* --- √ÅREA DE INPUT --- */
        .input-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #ffffff !important;
        }

        .input-section {
            background: #ffffff !important;
            border-radius: 15px;
            padding: 30px;
        }

        .instruction {
            background: #f8fdff;
            color: #004e92;
            padding: 15px;
            border-left: 4px solid #004e92;
            margin-bottom: 20px;
            font-size: 0.95em;
            border-radius: 4px;
        }

        .excel-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        .excel-table th {
            background: #ffffff !important;
            color: #1e3a8a; 
            padding: 12px;
            font-size: 0.8em; 
            text-transform: uppercase; 
            border: 1px solid #f0f0f0; 
        }
        
        .excel-table td { 
            border: 1px solid #f0f0f0; 
            padding: 0; 
            background: #ffffff !important;
        }
        
        .excel-input {
            width: 100%; 
            border: none; 
            padding: 12px; 
            font-family: monospace; font-size: 13px; outline: none;
            background: #ffffff !important;
        }
        .excel-input:focus { 
            background-color: #ffffff !important;
            box-shadow: inset 0 0 0 2px #e6f0ff; 
        }

        .btn-container { margin-top: 25px; text-align: center; }
        .btn {
            padding: 14px 35px; border: none; border-radius: 30px;
            font-weight: 600; cursor: pointer; margin: 0 10px;
            transition: transform 0.2s, background-color 0.2s;
            text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-gen { background: linear-gradient(90deg, #004e92 0%, #2b6cb0 100%); color: white; }
        .btn-clear { background: #94a3b8; color: white; }
        .btn-down { background: #10b981; color: white; display: none; }

        /* --- PREVIEW CONTAINER (OCULTO AT√â DOWNLOAD) --- */
        .preview-container {
            position: absolute;
            left: -10000px;
            top: 0;
            width: 1920px;
            overflow: visible;
            background: #ffffff !important;
        }

        /* --- DASHBOARD FINAL (1920px FIXO) --- */
        #dashboard-capture {
            width: 1920px !important;
            min-width: 1920px !important;
            padding: 60px;
            background: linear-gradient(135deg, #004e92 0%, #000428 100%);
            position: relative;
            z-index: 1;
        }

        .header { 
            text-align: center; color: white; margin-bottom: 40px;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .header img {
            width: 250px;
            margin-bottom: 20px;
            filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.3));
        }

        .header h1 { font-size: 2.8em; text-shadow: 2px 2px 6px rgba(0,0,0,0.5); margin-bottom: 5px; margin-top: 0; }
        .header p { font-size: 1.2em; opacity: 0.8; font-weight: 300; margin: 0; }

        /* --- CARDS & GRID (6 COLUNAS) --- */
        .cards-grid {
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 20px; 
            margin-bottom: 40px;
        }

        .card {
            border-radius: 15px; 
            padding: 25px 20px;
            display: flex; flex-direction: column; justify-content: center;
            height: 100%; position: relative; z-index: 2;
            background-color: #ffffff !important; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
        }

        .card.success { border-left: 6px solid #10b981 !important; }
        .card.warning { border-left: 6px solid #f59e0b !important; }
        .card.info { border-left: 6px solid #3b82f6 !important; }
        .card.danger { border-left: 6px solid #ef4444 !important; }
        
        .card-title { font-size: 0.9em; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; white-space: nowrap; }
        .card-value { font-size: 1.8em; font-weight: bold; color: #1e293b; margin-bottom: 5px; word-break: break-all; } 
        .card-subtitle { font-size: 0.85em; color: #94a3b8; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 35px; margin-bottom: 45px; }
        
        .chart-container {
            border-radius: 18px; padding: 35px; height: 550px; position: relative; z-index: 2;
            background-color: #ffffff !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
        }
        .chart-title { font-size: 1.4em; color: #1e293b; margin-bottom: 25px; font-weight: 600; }

        .table-container {
            border-radius: 18px; padding: 35px; position: relative; z-index: 2;
            background-color: #ffffff !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
        }
        
        table { width: 100%; border-collapse: collapse; }
        .table-container th {
            background: linear-gradient(135deg, #004e92 0%, #2b6cb0 100%);
            color: white; padding: 18px; text-align: left;
            font-weight: 600; text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.5px; border: none;
        }
        .table-container td { padding: 18px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 1em; }
        .table-container tr:hover { background: #f8fafc; }

        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .badge.success { background: #d1fae5; color: #065f46; }
        .badge.warning { background: #fed7aa; color: #92400e; }
        .badge.danger { background: #fee2e2; color: #991b1b; }

        .progress-bar { width: 100%; height: 10px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; border-radius: 10px; }

        .money { font-weight: 600; }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }

    </style>
</head>
<body>

    <div class="input-wrapper" id="inputArea">
        <div class="input-section">
            <h2 style="color: #004e92; margin-bottom: 10px;">üìã Gerador de Dashboard</h2>
            <div class="instruction">
                <strong>Instru√ß√£o:</strong> Copie os dados do Excel e cole na tabela abaixo. O sistema identificar√° as colunas automaticamente.
            </div>

            <div style="overflow-x: auto;">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>Vendedor</th><th>Meta</th><th>Vendido</th><th>%</th>
                            <th>Faturado</th><th>%</th><th>Total</th><th>%</th>
                            <th>Saldo</th><th>%</th><th>Meta Di√°ria</th>
                        </tr>
                    </thead>
                    <tbody id="inputBody"></tbody>
                </table>
            </div>

            <div class="btn-container">
                <button class="btn btn-clear" onclick="limparDados()">üóëÔ∏è Limpar</button>
                <button class="btn btn-gen" onclick="gerarDashboard()">‚öôÔ∏è Processar Dados</button>
                <button class="btn btn-down" id="btnDownload" onclick="baixarImagem()">üì∏ Baixar PNG</button>
            </div>
            <div id="statusMsg" style="text-align: center; color: #10b981; margin-top: 15px; font-weight: bold; display: none;">
                ‚úÖ Dados processados! Clique no bot√£o pulsante acima para baixar.
            </div>
        </div>
    </div>

    <div class="preview-container" id="previewContainer">
        <div id="dashboard-capture">
            <div class="header">
                <img src="https://i.postimg.cc/25LXCBjJ/logo-hortizontal-psr-branca-nova.png" alt="PSR Logo" crossorigin="anonymous">
                <h1>Dashboard de Vendas</h1>
                <p id="data-hora">Atualizado em tempo real</p>
            </div>

            <div class="cards-grid">
                <div class="card success">
                    <div class="card-title">Meta Total</div>
                    <div class="card-value" id="kpi-meta">R$ 0,00</div>
                    <div class="card-subtitle">Objetivo do per√≠odo</div>
                </div>

                 <div class="card warning">
                    <div class="card-title">Vendido Total</div>
                    <div class="card-value" id="kpi-vendido">R$ 0,00</div>
                    <div class="card-subtitle">Pedidos em carteira</div>
                </div>

                <div class="card info">
                    <div class="card-title">Faturado Total</div>
                    <div class="card-value" id="kpi-faturado">R$ 0,00</div>
                    <div class="card-subtitle">Faturamento consolidado</div>
                </div>

                <div class="card success">
                    <div class="card-title">Total</div>
                    <div class="card-value" id="kpi-total">R$ 0,00</div>
                    <div class="card-subtitle" style="display: flex; align-items: center;">
                        <span class="badge success" id="kpi-perc-badge">0% da meta</span>
                        <span style="margin-left: 8px; font-weight: 600; font-size: 0.85em;">VENDIDO + FATURADO</span>
                    </div>
                </div>
                
                <div class="card danger">
                    <div class="card-title">Saldo</div>
                    <div class="card-value" id="kpi-saldo">R$ 0,00</div>
                    <div class="card-subtitle">Saldo para Meta</div>
                </div>

                <div class="card warning">
                    <div class="card-title">Meta Di√°ria</div>
                    <div class="card-value" id="kpi-diaria">R$ 0,00</div>
                    <div class="card-subtitle">Gap do dia</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Performance por Vendedor</div>
                    <canvas id="chart1"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Meta vs Realizado</div>
                    <canvas id="chart2"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="chart-title">Detalhamento da Equipe</div>
                <table>
                    <thead>
                        <tr>
                            <th>Vendedor</th>
                            <th>Meta</th>
                            <th>Vendido</th>
                            <th>Faturado</th>
                            <th>Total</th>
                            <th>% Meta</th>
                            <th>Saldo</th>
                            <th>Meta Di√°ria</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody id="finalTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        const inputBody = document.getElementById('inputBody');
        for(let i=0; i<15; i++) {
            let tr = document.createElement('tr');
            for(let j=0; j<11; j++) {
                let td = document.createElement('td');
                let input = document.createElement('input');
                input.className = 'excel-input';
                if(i===0 && j===0) input.placeholder = "Cole aqui (Ctrl+V)";
                td.appendChild(input);
                tr.appendChild(td);
            }
            inputBody.appendChild(tr);
        }

        function limparDados() {
            document.querySelectorAll('.excel-input').forEach(input => input.value = '');
            const btn = document.getElementById('btnDownload');
            btn.style.display = 'none';
            btn.classList.remove('btn-attention');
            document.getElementById('statusMsg').style.display = 'none';
        }

        function cleanNumber(str) {
            if (!str) return 0;
            let s = str.toString();
            const isNegative = s.includes('-');
            let clean = s.replace(/[^0-9,]/g, '').replace(',', '.');
            let num = parseFloat(clean) || 0;
            return isNegative ? -num : num;
        }

        function formatMoney(num) {
            return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // --- L√ìGICA DE COLAR PRESERVADA ---
        inputBody.addEventListener('paste', function(e) {
            e.preventDefault();
            const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
            const rawRows = clipboardData.split(/\r\n|\n|\r/);
            const validRows = rawRows.filter(row => row.trim().length > 0);
            limparDados();

            validRows.forEach((row, rIndex) => {
                const tr = inputBody.children[rIndex];
                if (!tr) return;
                
                const rawCols = row.split('\t');
                const cleanCols = [];
                
                // Se tiver muitas colunas (tabula√ß√£o extra), filtra colunas pares
                if (rawCols.length > 15) {
                    for(let i = 0; i < rawCols.length; i++) {
                         if (i % 2 === 0) cleanCols.push(rawCols[i]);
                    }
                } else {
                    rawCols.forEach(c => cleanCols.push(c));
                }

                const inputsDaLinha = tr.querySelectorAll('input');
                cleanCols.forEach((val, cIndex) => {
                    if (inputsDaLinha[cIndex]) inputsDaLinha[cIndex].value = val.trim();
                });
            });
        });

        let chart1Instance = null;
        let chart2Instance = null;

        function gerarDashboard() {
            const agora = new Date();
            const dataStr = agora.toLocaleDateString('pt-BR');
            const horaStr = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('data-hora').innerText = `Atualizado em ${dataStr} √†s ${horaStr}`;

            const trs = inputBody.querySelectorAll('tr');
            let data = [];
            
            let totalMeta = 0, totalVendido = 0, totalFaturado = 0, totalRealizado = 0, totalSaldo = 0, totalMetaDiaria = 0;

            trs.forEach(tr => {
                const inps = tr.querySelectorAll('input');
                const nome = inps[0].value;
                if(!nome || nome.toUpperCase() === 'TOTAL' || nome.toUpperCase().includes('VENDEDOR')) return;

                const meta = cleanNumber(inps[1].value);
                const vendido = cleanNumber(inps[2].value);
                const faturado = cleanNumber(inps[4].value);
                const total = cleanNumber(inps[6].value);
                const perc = cleanNumber(inps[7].value);
                const saldo = cleanNumber(inps[8].value);
                
                let metaDiaria = 0;
                if(inps[10] && inps[10].value.trim() !== "") {
                    metaDiaria = cleanNumber(inps[10].value);
                } else {
                    metaDiaria = meta - total;
                }

                totalMeta += meta;
                totalVendido += vendido;
                totalFaturado += faturado;
                totalRealizado += total;
                totalSaldo += saldo;
                totalMetaDiaria += metaDiaria;

                data.push({ nome, meta, vendido, faturado, total, perc, saldo, metaDiaria });
            });

            if(data.length === 0) { alert('Cole dados primeiro!'); return; }

            const vdIndex = data.findIndex(d => d.nome.toUpperCase().includes('VENDA DIRETA'));
            if (vdIndex > -1) {
                const vendaDiretaItem = data.splice(vdIndex, 1)[0];
                data.unshift(vendaDiretaItem);
            }

            // Atualiza Cards
            document.getElementById('kpi-meta').innerText = formatMoney(totalMeta);
            document.getElementById('kpi-vendido').innerText = formatMoney(totalVendido);
            document.getElementById('kpi-faturado').innerText = formatMoney(totalFaturado);
            document.getElementById('kpi-total').innerText = formatMoney(totalRealizado);
            document.getElementById('kpi-saldo').innerText = formatMoney(totalSaldo);
            document.getElementById('kpi-diaria').innerText = formatMoney(totalMetaDiaria);

            const percGeral = totalMeta > 0 ? (totalRealizado/totalMeta)*100 : 0;
            const badgeEl = document.getElementById('kpi-perc-badge');
            badgeEl.innerText = `${percGeral.toFixed(0)}% da meta`;
            badgeEl.className = `badge ${percGeral >= 100 ? 'success' : percGeral >= 80 ? 'warning' : 'danger'}`;

            const tbody = document.getElementById('finalTableBody');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                const badgeClass = d.perc >= 100 ? 'success' : d.perc >= 80 ? 'warning' : 'danger';
                const saldoClass = d.saldo >= 0 ? 'positive' : 'negative';
                let barColor;
                if (d.perc >= 100) barColor = '#10b981';
                else if (d.perc >= 50) barColor = '#daa520';
                else barColor = '#ef4444';

                const row = `
                    <tr>
                        <td><strong>${d.nome}</strong></td>
                        <td class="money">R$ ${d.meta.toLocaleString('pt-BR')}</td>
                        <td class="money">R$ ${d.vendido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="money">R$ ${d.faturado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="money"><strong>R$ ${d.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                        <td><span class="badge ${badgeClass}">${d.perc.toFixed(0)}%</span></td>
                        <td class="money ${saldoClass}">${formatMoney(d.saldo)}</td>
                        <td class="money" style="color: #64748b;">${formatMoney(d.metaDiaria)}</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(d.perc, 100)}%; background: ${barColor};"></div>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            renderCharts(data);
            
            const btn = document.getElementById('btnDownload');
            btn.style.display = 'inline-block';
            btn.classList.add('btn-attention');
            document.getElementById('statusMsg').style.display = 'block';
        }

        function renderCharts(data) {
            const backgroundColors = data.map(d => {
                if (d.perc >= 100) return '#10b981'; 
                if (d.perc >= 50) return '#daa520'; 
                return '#ef4444'; 
            });

            if(chart1Instance) chart1Instance.destroy();
            const ctx1 = document.getElementById('chart1').getContext('2d');
            chart1Instance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.nome),
                    datasets: [{
                        label: '% Atingimento',
                        data: data.map(d => d.perc),
                        backgroundColor: backgroundColors,
                        borderRadius: 5
                    }]
                },
                options: { 
                    animation: false,
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: { padding: { top: 30, bottom: 20 } },
                    plugins: { 
                        legend: {display: false},
                        datalabels: {
                            anchor: 'end', align: 'top', formatter: Math.round,
                            font: { weight: 'bold', size: 14 },
                            formatter: function(value) { return value.toFixed(0) + '%'; },
                            color: '#333'
                        }
                    },
                    scales: {
                        x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: false, font: { size: 11, weight: '600' } } },
                        y: { beginAtZero: true }
                    }
                }
            });

            if(chart2Instance) chart2Instance.destroy();
            const ctx2 = document.getElementById('chart2').getContext('2d');
            chart2Instance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: data.map(d => d.nome),
                    datasets: [
                        { 
                            label: 'Meta', 
                            data: data.map(d => d.meta), 
                            borderColor: '#ef4444', 
                            borderWidth: 3, 
                            tension: 0.4,
                            pointStyle: 'circle',
                            pointRadius: 4,
                        },
                        { 
                            label: 'Realizado', 
                            data: data.map(d => d.total), 
                            borderColor: '#10b981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                            fill: true, 
                            tension: 0.4,
                            pointStyle: 'circle',
                            pointRadius: 4,
                        }
                    ]
                },
                options: { 
                    animation: false,
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { bottom: 20 } },
                    plugins: { 
                        datalabels: { display: false },
                        legend: {
                            display: true, position: 'top', align: 'end',
                            labels: {
                                usePointStyle: true, boxWidth: 10, padding: 15,
                                font: { family: "'Segoe UI', sans-serif", size: 11, weight: '600' },
                                color: '#475569'
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { maxRotation: 45, minRotation: 45, autoSkip: false, font: { size: 11, weight: '600' } } }
                    }
                }
            });
        }

        function baixarImagem() {
            const btn = document.getElementById('btnDownload');
            btn.classList.remove('btn-attention');
            
            const element = document.getElementById('dashboard-capture');
            html2canvas(element, {
                scale: 3, 
                useCORS: true,
                backgroundColor: null 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'dashboard-psr.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }
    </script>
</body>
</html>
